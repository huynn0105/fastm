import 'package:app_settings/app_settings.dart';
import 'package:flutter/material.dart';
import 'package:flutter_module/services/local/local_data_helper.dart';
import 'package:permission_handler/permission_handler.dart';

import '../dialogs/dialog_provider.dart';

class CameraUtil {
  CameraUtil._();

  static final CameraUtil instance = CameraUtil._();

  Future<bool> requestPermission({BuildContext? context}) async {
    PermissionStatus permission = await Permission.camera.request();
    if (permission == PermissionStatus.permanentlyDenied) {
      if (context?.mounted == true) {
        _showOpenAppSettingsDialog(context!);
      }
      return false;
    } else if (permission == PermissionStatus.denied) {
      final hasDenied = LocalDataHelper.instance.getCameraPermissionHasBeenDenied();
      if (hasDenied) {
        _showOpenAppSettingsDialog(context!);
      } else {
        LocalDataHelper.instance.setCameraPermissionHasBeenDenied(true);
      }
      return false;
    }
    LocalDataHelper.instance.removeCameraPermissionHasBeenDenied();
    return true;
  }

  _showOpenAppSettingsDialog(BuildContext context) {
    DialogProvider.instance.showConfirmDialog(
      context,
      title: 'Thông báo',
      message: 'Vui lòng cho phép Quyền camera để sử dụng chức năng này!',
      negativeTitle: 'Hủy',
      positiveTitle: 'Đồng ý',
      positiveCallback: () {
        AppSettings.openAppSettings();
      },
    );
  }
}
