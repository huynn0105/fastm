import 'package:dio/dio.dart';

import '../../../common/utils/text_util.dart';

class AuthInterceptors extends Interceptor {
  AuthInterceptors({required this.onUnauthorized});

  final Function() onUnauthorized;

  @override
  void onResponse(Response response, ResponseInterceptorHandler handler) {
    final json = (response.data is Map<String, dynamic>) ? response.data : TextUtils.decode(response.data.toString());
    final message = (json['message']?.toString() ?? '').toLowerCase();
    final code = (json['errorCode']?.toString() ?? json['error_code']?.toString() ?? '').toString().toLowerCase();
    final errorMessages = [
      'đăng nhập',
      'invalid token',
      'Token invalid',
      'Invalid token!',
    ];
    final errorCodes = [
      'login',
      'INVALID_ACCESS_TOKEN',
    ];
    if (errorCodes.any((e) => code.contains(e)) || errorMessages.any((e) => message.contains(e))) {
      onUnauthorized();
    }
    super.onResponse(response, handler);
  }
}
