import 'package:collection/collection.dart';
import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:flutter_module/common/bloc_status.dart';
import 'package:flutter_module/common/bottom_sheet/wrapper/data_wrapper.dart';
import 'package:flutter_module/common/colors.dart';
import 'package:flutter_module/common/styles.dart';
import 'package:flutter_module/common/widgets/images.dart';
import 'package:flutter_module/common/widgets/loading.dart';
import 'package:flutter_module/features/client/pages/client_detail/widgets/dialog/confirm_dialog.dart';
import 'package:flutter_module/features/mtrade/cubit/personal_link_setup/mtrade_personal_link_setup_cubit.dart';

class DialogRemoveAdLinkComponent extends StatelessWidget {
  const DialogRemoveAdLinkComponent({
    super.key,
    this.onConfirm,
    this.confirmTittleButton,
    this.onDone,
  });

  final VoidCallback? onConfirm;
  final String? confirmTittleButton;
  final VoidCallback? onDone;

  @override
  Widget build(BuildContext context) {
    return BlocBuilder<MTradePersonalLinkSetupCubit, MTradePersonalLinkSetupState>(
      builder: (context, state) {
        final listCommissionDifference = [];
        final listInsurance = state.data?.listInsurance ?? [];
        final listInsuranceConfig = state.data?.detail?.insuranceConfigArr ?? {};
        final listInsuranceChange = state.data?.detail?.insuranceDiscount ?? {};

        final listActive = state.data?.detail?.insuranceActiveArr ?? [];
        for (var id in listActive) {
          final prevCommission = listInsuranceConfig[id];
          final commission = listInsuranceChange[id];
          if (prevCommission != commission) {
            final insurance = listInsurance.firstWhereOrNull((element) => element.iD == id);
            listCommissionDifference.add(DataWrapper(
              id: commission,
              value: insurance?.name,
            ));
          }
        }
        if (state.removeStatus.isLoading) {
          return Container(
            decoration: BoxDecoration(
              color: UIColors.white,
              borderRadius: BorderRadius.circular(16),
            ),
            padding: const EdgeInsets.all(16),
            child: Column(
              mainAxisSize: MainAxisSize.min,
              children: [
                const LoadingWidget.withoutText(),
                const SizedBox(
                  height: 16,
                ),
                Text(
                  "Đang xóa link quảng cáo, vui lòng không thoát ứng dụng lúc này",
                  style: UITextStyle.regular.copyWith(
                    color: UIColors.grayText,
                  ),
                  textAlign: TextAlign.center,
                ),
                const SizedBox(
                  height: 16,
                ),
              ],
            ),
          );
        }

        if (state.removeStatus.isSuccess) {
          return ClientConfirmDialog(
            positiveTitle: "Hoàn tất",
            onPositive: () {
              onDone?.call();
            },
            hideNegative: true,
            child: Column(
              children: [
                const SizedBox(
                  height: 20,
                ),
                const AppImage.asset(
                  asset: "ic_success_outline",
                  width: 56,
                  height: 56,
                ),
                const SizedBox(
                  height: 12,
                ),
                Text(
                  "Xoá liên kết thành công",
                  style: UITextStyle.semiBold.copyWith(
                    fontSize: 16,
                    color: UIColors.green,
                  ),
                ),
                const SizedBox(
                  height: 12,
                ),
                Padding(
                  padding: const EdgeInsets.symmetric(horizontal: 16),
                  child: Text(
                    state.actionMessage ?? '',
                    style: UITextStyle.regular.copyWith(
                      fontSize: 14,
                      color: UIColors.grayText,
                    ),
                    textAlign: TextAlign.center,
                  ),
                ),
                const SizedBox(
                  height: 16,
                ),
              ],
            ),
          );
        }

        if (state.removeStatus.isFailure) {
          return ClientConfirmDialog(
            positiveTitle: "Thử lại",
            negativeTitle: 'Để sau',
            negativeColor: UIColors.grayText,
            positiveColor: UIColors.primaryColor,
            onNegative: () {
              Navigator.of(context).pop();
            },
            onPositive: () {
              onConfirm?.call();
            },
            child: Column(
              children: [
                const SizedBox(
                  height: 20,
                ),
                const AppImage.asset(
                  asset: "ic_popup_error_icon",
                  width: 56,
                  height: 56,
                ),
                const SizedBox(
                  height: 12,
                ),
                Text(
                  "Xoá liên kết thất bại",
                  style: UITextStyle.semiBold.copyWith(
                    fontSize: 16,
                    color: UIColors.red,
                  ),
                ),
                const SizedBox(
                  height: 12,
                ),
                Padding(
                  padding: const EdgeInsets.symmetric(horizontal: 16),
                  child: Text(
                    state.actionMessage ?? '',
                    style: UITextStyle.regular.copyWith(
                      fontSize: 14,
                      color: UIColors.grayText,
                    ),
                    textAlign: TextAlign.center,
                  ),
                ),
                const SizedBox(
                  height: 16,
                ),
              ],
            ),
          );
        }

        return ClientConfirmDialog(
          positiveTitle: 'Xem lại',
          negativeTitle: 'Xoá link',
          negativeColor: UIColors.red,
          positiveColor: UIColors.primaryColor,
          onNegative: () {
            onConfirm?.call();
          },
          onPositive: () {
            Navigator.of(context).pop();
          },
          child: Column(
            children: [
              const SizedBox(
                height: 20,
              ),
              const AppImage.asset(
                asset: "ic_notification",
                width: 56,
                height: 56,
                color: UIColors.orange,
              ),
              const SizedBox(
                height: 12,
              ),
              Text(
                "Xác nhận yêu cầu",
                style: UITextStyle.semiBold.copyWith(
                  fontSize: 16,
                  color: UIColors.orangeText,
                ),
              ),
              const SizedBox(
                height: 12,
              ),
              Padding(
                padding: const EdgeInsets.symmetric(horizontal: 16),
                child: Text(
                  'Sau khi xóa, link quảng cáo sẽ không thể truy cập. Tuy nhiên, các khách hàng đến từ link này vẫn hiển thị tại tệp khách hàng của bạn.',
                  style: UITextStyle.regular.copyWith(
                    fontSize: 14,
                    color: UIColors.grayText,
                  ),
                  textAlign: TextAlign.center,
                ),
              ),
              const SizedBox(
                height: 8,
              ),
              const SizedBox(
                height: 16,
              ),
            ],
          ),
        );
      },
    );
  }
}
