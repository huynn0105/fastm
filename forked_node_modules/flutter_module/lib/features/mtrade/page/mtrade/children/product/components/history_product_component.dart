import 'dart:math';

import 'package:auto_route/auto_route.dart';
import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import '../../../../../../../app_data.dart';
import '../../../../../../../common/bloc_status.dart';
import '../../../../../cubit/history_product/mtrade_history_product_cubit.dart';
import '../../../../../../../routes/routes.gr.dart';

import '../../../../../../../common/constants.dart';
import '../../../items/product_card.dart';
import '../../../widgets/mtrade_block_widget.dart';

class HistoryProductComponent extends StatelessWidget {
  const HistoryProductComponent({Key? key}) : super(key: key);

  @override
  Widget build(BuildContext context) {
    return BlocBuilder<MTradeHistoryProductCubit, MTradeHistoryProductState>(
      builder: (context, state) {
        if (state.status.isInitial) {
          context.read<MTradeHistoryProductCubit>().fetchData();
        }

        final data = state.products.take(5).toList();
        return data.isEmpty
            ? const SizedBox()
            : Padding(
                padding: const EdgeInsets.only(top: 18),
                child: MTradeBlockWidget(
                  title: "Sản phẩm xem / mua gần nhất",
                  titlePadding: const EdgeInsets.symmetric(horizontal: 16),
                  subtitle: "Tất cả",
                  onTapSubtitle: () {
                    context.pushRoute(
                      MTradeSearchedProductRoute(
                        title: "Sản phẩm xem / mua gần nhất",
                        group: "productHistory",
                        pageID: AppData.instance.landingPageID,
                        provinceCode: AppData.instance.landingPageProvinceCode,
                        districtCode: AppData.instance.landingPageDistrictCode,
                      ),
                    );
                  },
                  child: SizedBox(
                    width: double.infinity,
                    child: SingleChildScrollView(
                      physics: AppConstants.physics,
                      scrollDirection: Axis.horizontal,
                      padding: const EdgeInsets.symmetric(horizontal: 16),
                      child: IntrinsicHeight(
                        child: Row(
                          crossAxisAlignment: CrossAxisAlignment.stretch,
                          children: List.generate(
                            max(0, data.length * 2 - 1),
                            (index) {
                              if (index.isOdd) {
                                return const SizedBox(
                                  width: 10,
                                );
                              }
                              index = index ~/ 2;
                              final item = data[index];
                              return ProductCard.small(
                                data: item,
                                isIntrinsicHeight: true,
                              );
                            },
                          ),
                        ),
                      ),
                    ),
                  ),
                ),
              );
      },
    );
  }
}
