import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:flutter_module/common/bloc_status.dart';
import 'package:flutter_module/common/colors.dart';
import 'package:flutter_module/common/size.dart';
import 'package:flutter_module/common/styles.dart';
import 'package:flutter_module/common/toast/toast_provider.dart';
import 'package:flutter_module/common/utils/image_gallery_util.dart';
import 'package:flutter_module/common/widgets/buttons.dart';
import 'package:flutter_module/common/widgets/images.dart';
import 'package:flutter_module/features/client/pages/client_detail/items/attachment_image_item.dart';
import 'package:flutter_module/features/webview/cubit/download_images/download_images_cubit.dart';
import 'package:flutter_module/models/client/client_detail/client_document_model.dart';

class PreviewImagesComponent extends StatefulWidget {
  const PreviewImagesComponent({
    super.key,
    required this.data,
    this.url,
  });

  final List<ClientDocumentModel> data;
  final String? url;

  @override
  State<PreviewImagesComponent> createState() => _PreviewImagesComponentState();
}

class _PreviewImagesComponentState extends State<PreviewImagesComponent> {
  String? urlSelected;

  @override
  void initState() {
    super.initState();
    setState(() {
      urlSelected = widget.url;
    });
  }

  @override
  Widget build(BuildContext context) {
    return BlocProvider(
      create: (context) => DownloadImagesCubit(),
      child: BlocBuilder<DownloadImagesCubit, DownloadImagesState>(
        builder: (context, state) {
          return Container(
            constraints: BoxConstraints(
              maxHeight: AppSize.instance.height * (urlSelected == null ? 0.7 : 0.8),
            ),
            child: Column(
              mainAxisSize: MainAxisSize.min,
              children: [
                Container(
                  height: 6,
                  width: 92,
                  margin: const EdgeInsets.only(top: 10),
                  decoration: BoxDecoration(
                    borderRadius: BorderRadius.circular(3),
                    color: UIColors.white,
                  ),
                ),
                const SizedBox(
                  height: 10,
                ),
                Container(
                  width: double.infinity,
                  height: 48,
                  decoration: const BoxDecoration(
                    color: UIColors.white,
                    borderRadius: BorderRadius.only(
                      topLeft: Radius.circular(24),
                      topRight: Radius.circular(24),
                    ),
                  ),
                  child: Row(
                    children: [
                      SizedBox(
                        width: 40,
                        height: 40,
                        child: urlSelected != null
                            ? IconButton(
                                onPressed: () {
                                  setState(() {
                                    urlSelected = null;
                                  });
                                },
                                icon: const Icon(
                                  Icons.arrow_back,
                                  color: UIColors.grayText,
                                  size: 24,
                                ),
                              )
                            : const SizedBox(),
                      ),
                      Expanded(
                        child: Text(
                          "Hình ảnh hồ sơ đi kèm",
                          style: UITextStyle.medium.copyWith(
                            fontSize: 16,
                            color: UIColors.grayText,
                          ),
                          textAlign: TextAlign.center,
                        ),
                      ),
                      SizedBox(
                        width: 40,
                        height: 40,
                        child: IconButton(
                          onPressed: () {
                            Navigator.of(context).pop();
                          },
                          icon: const Icon(
                            Icons.clear_rounded,
                            color: UIColors.grayText,
                            size: 24,
                          ),
                        ),
                      ),
                    ],
                  ),
                ),
                Flexible(
                  child: Container(
                    decoration: const BoxDecoration(
                      color: UIColors.background,
                    ),
                    child: Stack(
                      children: [
                        if (urlSelected == null) ...[
                          ListView(
                            shrinkWrap: true,
                            padding: EdgeInsets.only(
                              left: 16,
                              right: 16,
                              bottom: AppSize.instance.safeBottom,
                            ),
                            children: [
                              ...List.generate(widget.data.length, (index) {
                                final item = widget.data[index];
                                return AttachmentImageItem(
                                  item: item,
                                  onTapImage: (image) {
                                    setState(() {
                                      urlSelected = image;
                                    });
                                  },
                                );
                              })
                            ],
                          ),
                        ] else ...[
                          Column(
                            mainAxisSize: MainAxisSize.min,
                            children: [
                              Flexible(
                                child: Container(
                                  margin: const EdgeInsets.all(24),
                                  decoration: BoxDecoration(
                                    borderRadius: BorderRadius.circular(8),
                                    color: UIColors.white,
                                  ),
                                  clipBehavior: Clip.hardEdge,
                                  child: AutoHeightImage(
                                    url: urlSelected ?? '',
                                  ),
                                ),
                              ),
                              Container(
                                padding: EdgeInsets.only(
                                  bottom: AppSize.instance.safeBottom,
                                  left: 16,
                                  right: 16,
                                ),
                                decoration: const BoxDecoration(
                                  color: UIColors.white,
                                  borderRadius: BorderRadius.only(
                                    topLeft: Radius.circular(16),
                                    topRight: Radius.circular(16),
                                  ),
                                ),
                                child: SizedBox(
                                  height: 56,
                                  child: Row(
                                    mainAxisAlignment: MainAxisAlignment.spaceAround,
                                    children: [
                                      SplashButton(
                                        isDisabled: state.status.isLoading,
                                        onTap: () {
                                          _onShareImage(context, [urlSelected ?? '']);
                                        },
                                        child: Row(
                                          children: [
                                            Container(
                                              alignment: Alignment.center,
                                              padding: const EdgeInsets.all(6),
                                              child: const AppImage.asset(
                                                asset: "ic_chat_send",
                                                width: 24,
                                                height: 24,
                                                color: UIColors.primaryColor,
                                              ),
                                            ),
                                            const SizedBox(
                                              width: 4,
                                            ),
                                            Text(
                                              "Chia sẻ",
                                              style: UITextStyle.medium.copyWith(
                                                color: UIColors.primaryColor,
                                                fontSize: 16,
                                              ),
                                            ),
                                          ],
                                        ),
                                      ),
                                      SplashButton(
                                        isDisabled: state.status.isLoading,
                                        onTap: () {
                                          _onSaveImage(context, [urlSelected ?? '']);
                                        },
                                        child: Center(
                                          child: Row(
                                            children: [
                                              Container(
                                                alignment: Alignment.center,
                                                padding: const EdgeInsets.all(6),
                                                child: state.status.isLoading
                                                    ? const SizedBox(
                                                        width: 24,
                                                        height: 24,
                                                        child: CircularProgressIndicator(
                                                          color: UIColors.primaryColor,
                                                          strokeWidth: 2,
                                                        ),
                                                      )
                                                    : const AppImage.asset(
                                                        asset: "ic_download",
                                                        width: 24,
                                                        height: 24,
                                                        color: UIColors.primaryColor,
                                                      ),
                                              ),
                                              const SizedBox(
                                                width: 4,
                                              ),
                                              Text(
                                                "Lưu về máy",
                                                style: UITextStyle.medium.copyWith(
                                                  color: UIColors.primaryColor,
                                                  fontSize: 16,
                                                ),
                                              )
                                            ],
                                          ),
                                        ),
                                      ),
                                    ],
                                  ),
                                ),
                              )
                            ],
                          )
                        ]
                      ],
                    ),
                  ),
                ),
              ],
            ),
          );
        },
      ),
    );
  }

  _onSaveImage(BuildContext context, List<String> images) {
    final cubit = context.read<DownloadImagesCubit>();
    cubit.download(
      urls: images,
      onSuccess: (paths) {
        ImageGalleryUtil.instance.saveLocalImage(
          paths: paths,
          context: context,
          onSuccess: () {
            ToastProvider.instance.show(
              context: context,
              message: "Lưu ảnh thành công",
              backgroundColor: UIColors.green,
              duration: const Duration(seconds: 2),
            );
          },
          onFailure: () {
            ToastProvider.instance.show(
              context: context,
              message: "Lưu ảnh thất bại",
              backgroundColor: UIColors.red,
              duration: const Duration(seconds: 2),
            );
          },
        );
      },
    );
  }

  _onShareImage(BuildContext context, List<String> images) {
    final cubit = context.read<DownloadImagesCubit>();
    cubit.share(
      urls: images,
    );
  }
}
