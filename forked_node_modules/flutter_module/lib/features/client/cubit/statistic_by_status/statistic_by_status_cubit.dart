import 'package:bloc/bloc.dart';
import 'package:collection/collection.dart';
import 'package:equatable/equatable.dart';
import 'package:flutter_module/common/bloc_status.dart';
import 'package:flutter_module/common/colors.dart';
import 'package:flutter_module/common/enum/client/client_tab_type.dart';
import 'package:flutter_module/common/extension/list_extension.dart';
import 'package:flutter_module/common/utils/text_util.dart';
import 'package:flutter_module/common/widgets/chart/donut_chart/donut_chart_controller.dart';
import 'package:flutter_module/common/widgets/chart/donut_chart/donut_chart_data.dart';
import 'package:flutter_module/features/client/repository/client_repository.dart';
import 'package:flutter_module/models/client_data/client_statistic_model.dart';

part 'statistic_by_status_state.dart';

class StatisticByStatusCubit extends Cubit<StatisticByStatusState> {
  StatisticByStatusCubit() : super(const StatisticByStatusState());
  DonutChartController controller = DonutChartController();
  ClientRepository repository = ClientRepository();

  initCubit() {
    emit(state.copyWith(
      category: ClientTabType.pl.name,
    ));
  }

  fetchData() async {
    emit(state.copyWith(
      status: BlocStatus.loading,
    ));
    final result = await repository.getStatisticByStatus(
      category: state.category,
    );
    if (result.status) {
      emit(state.copyWith(
        status: BlocStatus.success,
        statistic: result.data,
      ));
    } else {
      emit(state.copyWith(
        status: BlocStatus.failure,
      ));
    }
  }

  DonutChartData getDonutChartData() {
    return DonutChartData.success(
      sections: (state.statistic?.data ?? [])
          .mapIndexed(
            (i, e) => DonutChartSectionData(
              color: UIColors.statisticColors.valueAt(i) ?? UIColors.primaryColor,
              label: "${e.title}>>",
              unit: 'người',
              value: TextUtils.parseDouble(e.count) ?? 0,
              percent: e.percent,
            ),
          )
          .toList(),
    );
  }

  changeCategory(String id) {
    emit(state.copyWith(
      category: id,
    ));
  }

  @override
  Future<void> close() {
    controller.dispose();
    return super.close();
  }
}
