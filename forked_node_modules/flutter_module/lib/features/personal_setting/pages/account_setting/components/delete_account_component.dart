import 'package:auto_route/auto_route.dart';
import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:flutter_module/common/bloc_status.dart';
import 'package:flutter_module/common/colors.dart';
import 'package:flutter_module/common/constants.dart';
import 'package:flutter_module/common/size.dart';
import 'package:flutter_module/common/styles.dart';
import 'package:flutter_module/common/widgets/buttons.dart';
import 'package:flutter_module/common/widgets/divider.dart';
import 'package:flutter_module/common/widgets/images.dart';
import 'package:flutter_module/common/widgets/loading.dart';
import 'package:flutter_module/common/widgets/pin_code/pin_code_component.dart';
import 'package:flutter_module/common/widgets/textfields.dart';
import 'package:flutter_module/features/account/cubit/user/user_cubit.dart';
import 'package:flutter_module/features/personal_setting/cubit/delete_account/delete_account_cubit.dart';

class DeleteAccountComponent extends StatefulWidget {
  const DeleteAccountComponent({super.key});

  @override
  State<DeleteAccountComponent> createState() => _DeleteAccountComponentState();
}

class _DeleteAccountComponentState extends State<DeleteAccountComponent> {
  @override
  Widget build(BuildContext context) {
    return BlocProvider(
      create: (context) => DeleteAccountCubit(),
      child: BlocBuilder<DeleteAccountCubit, DeleteAccountState>(
        builder: (context, state) {
          final cubit = context.read<DeleteAccountCubit>();
          final userCubit = context.read<UserCubit>();
          final phoneNumber = userCubit.state.userMetaData?.mobilePhone ?? "";
          return SizedBox(
            height: AppSize.instance.height * 0.6,
            width: double.infinity,
            child: Stack(
              children: [
                ListView(
                  padding: const EdgeInsets.all(16),
                  children: [
                    if (state.status.isFailure) ...[
                      const SizedBox(
                        height: 56,
                      ),
                      Stack(
                        alignment: Alignment.center,
                        clipBehavior: Clip.none,
                        children: [
                          Container(
                            width: double.infinity,
                            padding: const EdgeInsets.all(16),
                            decoration: BoxDecoration(
                              color: UIColors.white,
                              borderRadius: BorderRadius.circular(8),
                            ),
                            child: Column(
                              children: [
                                const SizedBox(
                                  height: 80,
                                ),
                                Text(
                                  "Thất bại",
                                  style: UITextStyle.semiBold.copyWith(fontSize: 18, color: UIColors.red),
                                  textAlign: TextAlign.center,
                                ),
                                const DottedDivider(
                                  height: 12,
                                ),
                                SizedBox(
                                  width: double.infinity,
                                  child: Text(
                                    "Yêu cầu hủy tài khoản đã xảy ra lỗi, vui lòng thử lại!",
                                    style: UITextStyle.regular,
                                  ),
                                ),
                              ],
                            ),
                          ),
                          const Positioned(
                            top: -56,
                            child: AppImage.asset(
                              asset: "ic_mtrade_mascot_error",
                              width: 140,
                              height: 140,
                            ),
                          ),
                        ],
                      ),
                      const SizedBox(
                        height: 24,
                      ),
                      PrimaryButton(
                        onPressed: () {
                          context.popRoute();
                        },
                        title: "Quay lại",
                      ),
                    ] else if (state.status.isSuccess) ...[
                      const SizedBox(
                        height: 56,
                      ),
                      Stack(
                        alignment: Alignment.center,
                        clipBehavior: Clip.none,
                        children: [
                          Container(
                            width: double.infinity,
                            padding: const EdgeInsets.all(16),
                            decoration: BoxDecoration(
                              color: UIColors.white,
                              borderRadius: BorderRadius.circular(8),
                            ),
                            child: Column(
                              children: [
                                const SizedBox(
                                  height: 80,
                                ),
                                Text(
                                  "Yêu cầu hủy tài khoản của bạn đã được ghi nhận",
                                  style: UITextStyle.semiBold.copyWith(
                                    fontSize: 18,
                                  ),
                                  textAlign: TextAlign.center,
                                ),
                                const DottedDivider(
                                  height: 12,
                                ),
                                SizedBox(
                                  width: double.infinity,
                                  child: Text(
                                    "Tài khoản sẽ được hủy trong vòng 30 ngày.",
                                    style: UITextStyle.bold.copyWith(
                                      color: UIColors.red,
                                    ),
                                  ),
                                ),
                                Text(
                                  "Sau thời gian này, thông tin giao dịch, thông tin cá nhân, số dư MFast đều sẽ bị xóa và không thể khôi phục",
                                  style: UITextStyle.regular,
                                ),
                              ],
                            ),
                          ),
                          const Positioned(
                            top: -56,
                            child: AppImage.asset(
                              asset: "ic_mascot_sit_cry",
                              width: 140,
                              height: 140,
                            ),
                          ),
                        ],
                      ),
                      const SizedBox(
                        height: 24,
                      ),
                      PrimaryButton(
                        onPressed: () {
                          context.router.popUntilRoot();
                        },
                        title: "Trở về trang cá nhân",
                      ),
                    ] else if (state.isVerifyOTP) ...[
                      const SizedBox(
                        height: 16,
                      ),
                      PinCodeComponent(
                        data: phoneNumber,
                        onTapResendOption: (type) {
                          _onRequestOtp(
                            context,
                            mobilePhone: phoneNumber,
                            isRetry: true,
                            type: type,
                          );
                        },
                        countdownTime: 60,
                        onOtpChange: cubit.otpChange,
                        errorMsg: state.errorFields[AppConstants.otpKey],
                        onComplete: (otp) {
                          _onDeleteAccount(context, otp: otp);
                        },
                      ),
                    ] else ...[
                      Center(
                        child: Stack(
                          children: [
                            const AppImage.asset(
                              asset: 'ic_mfast_logo',
                              width: 64,
                              height: 64,
                            ),
                            Positioned(
                              bottom: 0,
                              right: 0,
                              child: Container(
                                width: 32,
                                height: 32,
                                decoration: const BoxDecoration(
                                  shape: BoxShape.circle,
                                  color: UIColors.background,
                                ),
                                child: const Center(
                                  child: AppImage.asset(
                                    asset: "ic_trash",
                                    width: 24,
                                    height: 24,
                                  ),
                                ),
                              ),
                            ),
                          ],
                        ),
                      ),
                      const SizedBox(
                        height: 12,
                      ),
                      Text(
                        "Yêu cầu hủy tài khoản MFast",
                        style: UITextStyle.semiBold.copyWith(
                          fontSize: 18,
                          color: UIColors.boolText,
                        ),
                        textAlign: TextAlign.center,
                      ),
                      const SizedBox(
                        height: 16,
                      ),
                      SizedBox(
                        height: 80,
                        child: UITextFieldOutline(
                          controller: cubit.reasonController,
                          hintText: "Nhập lý do hủy",
                          maxLines: 100,
                          contentPadding: const EdgeInsets.symmetric(
                            horizontal: 16,
                            vertical: 12,
                          ),
                          hintTextStyle: UITextStyle.medium.copyWith(
                            fontSize: 16,
                            color: UIColors.grayText,
                          ),
                          textStyle: UITextStyle.medium.copyWith(
                            fontSize: 16,
                          ),
                          onChanged: (p0) {
                            setState(() {});
                          },
                        ),
                      ),
                      const SizedBox(
                        height: 16,
                      ),
                      Row(
                        children: [
                          Expanded(
                            child: PrimaryButton(
                              title: "Xác nhận hủy",
                              enabled: cubit.reasonController.text.isNotEmpty,
                              buttonColor: UIColors.red,
                              onPressed: () {
                                _onRequestOtp(
                                  context,
                                  mobilePhone: phoneNumber,
                                );
                              },
                            ),
                          ),
                          const SizedBox(
                            width: 16,
                          ),
                          Expanded(
                            child: PrimaryButton(
                              title: "Suy nghĩ lại",
                              onPressed: () {
                                Navigator.of(context).pop();
                              },
                            ),
                          )
                        ],
                      ),
                      const SizedBox(
                        height: 32,
                      ),
                      Container(
                        padding: const EdgeInsets.all(12),
                        decoration: BoxDecoration(
                          borderRadius: BorderRadius.circular(8),
                          color: UIColors.lightRed,
                        ),
                        child: Row(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            const AppImage.asset(
                              asset: "ic_warning_circle",
                              width: 24,
                              height: 24,
                            ),
                            const SizedBox(
                              width: 8,
                            ),
                            Expanded(
                              child: RichText(
                                text: TextSpan(
                                  style: UITextStyle.regular,
                                  children: [
                                    const TextSpan(text: "Tài khoản sẽ được "),
                                    TextSpan(
                                      text: "hủy sau 30 ngày ",
                                      style: UITextStyle.bold.copyWith(
                                        color: UIColors.red,
                                      ),
                                    ),
                                    const TextSpan(
                                      text:
                                          "kể từ lúc yêu cầu. Sau thời gian này, thông tin giao dịch, thông tin cá nhân, số dư MFast đều sẽ bị xóa và không thể khôi phục",
                                    ),
                                  ],
                                ),
                              ),
                            ),
                          ],
                        ),
                      ),
                    ],
                  ],
                ),
                Visibility(
                  visible: state.otpStatus.isLoading || state.status.isLoading,
                  child: const LoadingWidget.dark(),
                )
              ],
            ),
          );
        },
      ),
    );
  }

  _onRequestOtp(
    BuildContext context, {
    required String mobilePhone,
    bool? isRetry,
    String? type,
  }) {
    final cubit = context.read<DeleteAccountCubit>();
    cubit.requestOTp(
      mobilePhone: mobilePhone,
      isRetry: isRetry,
      type: type,
    );
  }

  _onDeleteAccount(BuildContext context, {required String otp}) {
    final cubit = context.read<DeleteAccountCubit>();
    cubit.deleteAccount(otp: otp);
  }
}
