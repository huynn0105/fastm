import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:flutter_module/common/bloc_status.dart';
import 'package:flutter_module/common/widgets/collect_data_view.dart';
import 'package:flutter_module/common/widgets/images.dart';
import 'package:flutter_module/common/widgets/loading.dart';
import 'package:flutter_module/features/personal_setting/cubit/edit_nick_name/edit_nick_name_cubit.dart';

import '../../../../../common/colors.dart';
import '../../../../../common/styles.dart';
import '../../../../../common/widgets/buttons.dart';

class EditNicknameComponent extends StatelessWidget {
  const EditNicknameComponent({
    Key? key,
    required this.nickname,
  }) : super(key: key);

  final String nickname;

  @override
  Widget build(BuildContext context) {
    return BlocBuilder<EditNickNameCubit, EditNickNameState>(
      builder: (context, state) {
        final cubit = context.read<EditNickNameCubit>();

        if (!state.status.showLoading) {
          return EditNickNameStatusWidget(
            status: state.status,
            errorMessage: state.errorMessage,
          );
        }

        return Container(
          padding: const EdgeInsets.all(16),
          constraints: const BoxConstraints(
            minHeight: 300,
          ),
          child: Stack(
            children: [
              Column(
                mainAxisSize: MainAxisSize.min,
                children: [
                  CollectDataView(
                    errorMsg: state.errorFields[EditNickNameFields.nickName.name],
                    child: SizedBox(
                      height: 48,
                      child: TextField(
                        controller: cubit.nickNameController,
                        textAlign: TextAlign.center,
                        cursorWidth: 2,
                        cursorHeight: 23,
                        cursorColor: UIColors.primaryColor,
                        cursorRadius: const Radius.circular(8),
                        style: UITextStyle.medium.copyWith(
                          fontSize: 16,
                          height: 1.5,
                          color: UIColors.primaryColor,
                        ),
                        onChanged: cubit.onNickNameChanged,
                        decoration: InputDecoration(
                          filled: true,
                          fillColor: UIColors.white,
                          hintText: "Nhập nickname",
                          hintStyle: UITextStyle.medium.copyWith(
                            fontSize: 16,
                            height: 1.5,
                            color: UIColors.grayText,
                          ),
                          border: OutlineInputBorder(
                            borderSide: const BorderSide(
                              color: UIColors.background,
                            ),
                            borderRadius: BorderRadius.circular(50),
                          ),
                          focusedBorder: OutlineInputBorder(
                            borderSide: const BorderSide(
                              color: UIColors.primaryColor,
                            ),
                            borderRadius: BorderRadius.circular(50),
                          ),
                          contentPadding: const EdgeInsets.symmetric(
                            vertical: 8,
                            horizontal: 16,
                          ),
                        ),
                      ),
                    ),
                  ),
                  const SizedBox(
                    height: 16,
                  ),
                  Text(
                    "Nickname này sẽ dùng thay cho tên của bạn tại tất cả những nơi hiển thị và tìm kiếm trên MFast.",
                    style: UITextStyle.regular.copyWith(
                      color: UIColors.grayText,
                    ),
                    maxLines: 2,
                    textAlign: TextAlign.center,
                  ),
                  const SizedBox(
                    height: 16,
                  ),
                  RichText(
                    maxLines: 3,
                    textAlign: TextAlign.center,
                    text: TextSpan(
                      text: "Lưu ý, nickname ",
                      style: UITextStyle.regular,
                      children: [
                        TextSpan(
                          text: "không được bao gồm khoảng trằng ",
                          style: UITextStyle.semiBold.copyWith(
                            color: UIColors.darkBlue,
                          ),
                        ),
                        TextSpan(
                          text: "và ",
                          style: UITextStyle.regular,
                        ),
                        TextSpan(
                          text: "độ dài từ 5 đến 20 ký tự",
                          style: UITextStyle.semiBold.copyWith(
                            color: UIColors.darkBlue,
                          ),
                        ),
                        TextSpan(
                          text: ".",
                          style: UITextStyle.regular,
                        ),
                      ],
                    ),
                  ),
                  SizedBox(
                    height: 100,
                    child: Center(
                      child: PrimaryButton(
                        onPressed: () {
                          FocusManager.instance.primaryFocus?.unfocus();
                          cubit.submit();
                        },
                        enabled: state.enabledNextStep,
                        width: 200,
                        title: "Cập nhật",
                      ),
                    ),
                  ),
                ],
              ),
              Visibility(
                visible: state.status.isLoading,
                child: const SizedBox(
                  height: 250,
                  child: LoadingWidget.dark(),
                ),
              ),
            ],
          ),
        );
      },
    );
  }
}

class EditNickNameStatusWidget extends StatelessWidget {
  const EditNickNameStatusWidget({
    super.key,
    required this.status,
    required this.errorMessage,
  });

  final BlocStatus status;
  final String? errorMessage;

  @override
  Widget build(BuildContext context) {
    ///
    if (status.isSuccess) {
      return Container(
        height: 300,
        width: double.infinity,
        alignment: Alignment.center,
        padding: const EdgeInsets.all(16),
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            const AppImage.asset(
              asset: 'ic_success_outline',
              width: 48,
              height: 48,
            ),
            const SizedBox(
              height: 8,
            ),
            Text(
              'Thay đổi nickname thành công',
              style: UITextStyle.semiBold.copyWith(
                fontSize: 14,
                color: UIColors.green,
              ),
            ),
            const SizedBox(
              height: 4,
            ),
            Text(
              'Bạn có thể thay đổi nickname này bất cứ lúc nào, tại trang thông tin tài khoản của mình.',
              style: UITextStyle.regular.copyWith(
                fontSize: 14,
                color: UIColors.grayText,
              ),
              textAlign: TextAlign.center,
            ),
          ],
        ),
      );
    }

    ///
    if (status.isFailure) {
      return Container(
        height: 300,
        width: double.infinity,
        alignment: Alignment.center,
        padding: const EdgeInsets.all(16),
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            const AppImage.asset(
              asset: 'ic_error_outline',
              width: 48,
              height: 48,
            ),
            const SizedBox(
              height: 8,
            ),
            Text(
              'Cập nhật nickname thất bại',
              style: UITextStyle.semiBold.copyWith(
                fontSize: 14,
                color: UIColors.red,
              ),
            ),
            const SizedBox(
              height: 4,
            ),
            Text(
              errorMessage ?? 'Có lỗi xãy ra vui lòng thử lại',
              style: UITextStyle.regular.copyWith(
                fontSize: 14,
                color: UIColors.grayText,
              ),
              textAlign: TextAlign.center,
            ),
          ],
        ),
      );
    }

    ///
    return const SizedBox();
  }
}
