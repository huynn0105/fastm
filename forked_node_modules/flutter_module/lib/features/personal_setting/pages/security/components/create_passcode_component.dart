import 'package:flutter_module/common/widgets/images.dart';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:flutter_module/common/widgets/collect_data_view.dart';

import '../../../../../common/colors.dart';
import '../../../../../common/styles.dart';
import '../../../../../common/widgets/buttons.dart';
import '../../../../../common/widgets/textfields.dart';

class CreatePassCodeComponent extends StatefulWidget {
  const CreatePassCodeComponent({
    super.key,
    required this.description,
    this.errMsg,
    this.onComplete,
  });

  final String description;
  final String? errMsg;
  final Function(String)? onComplete;

  @override
  State<StatefulWidget> createState() {
    return _CreatePassCodeComponent();
  }
}

class _CreatePassCodeComponent extends State<CreatePassCodeComponent> {
  late final TextEditingController passwordController;
  late final TextEditingController confirmPasswordController;

  final FocusNode _focusNode = FocusNode();
  String? errMsg;

  @override
  void initState() {
    errMsg = widget.errMsg;
    passwordController = TextEditingController();
    confirmPasswordController = TextEditingController();
    super.initState();
  }

  @override
  void dispose() {
    _focusNode.dispose();
    passwordController.dispose();
    confirmPasswordController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: 24),
      child: Column(
        mainAxisSize: MainAxisSize.min,
        children: [
          const SizedBox(
            height: 16,
          ),
          Text(
            widget.description,
            textAlign: TextAlign.center,
            style: UITextStyle.regular,
          ),
          const SizedBox(
            height: 16,
          ),
          CollectDataView(
            errorMsg: errMsg,
            child: Column(
              children: [
                UITextFieldOutline(
                  controller: passwordController,
                  // focusNode: _focusNode,
                  autofocus: false,
                  obscureText: true,
                  borderRadius: 27,
                  hintText: 'Nhập mật khẩu',
                  prefixIcon: const Center(
                    child: AppImage.asset(
                      asset: 'ic_password',
                      width: 24,
                      height: 24,
                      color: UIColors.gray,
                    ),
                  ),
                  textAlign: TextAlign.center,
                  textStyle: UITextStyle.semiBold.copyWith(
                    fontSize: 16,
                  ),
                  hintTextStyle: UITextStyle.semiBold.copyWith(
                    fontSize: 16,
                    color: UIColors.gray,
                  ),
                  contentPadding: const EdgeInsets.only(left: 48, top: 14, bottom: 14),
                  inputFormatter: [
                    FilteringTextInputFormatter.digitsOnly,
                    LengthLimitingTextInputFormatter(6),
                  ],
                  keyboardType: TextInputType.number,
                  onChanged: (value) {
                    if (errMsg != null) {
                      errMsg = null;
                    }
                    setState(() {});
                    if (value.length == 6) {
                      _focusNode.requestFocus();
                    }
                  },
                ),
                const SizedBox(
                  height: 12,
                ),
                UITextFieldOutline(
                  controller: confirmPasswordController,
                  focusNode: _focusNode,
                  autofocus: false,
                  obscureText: true,
                  borderRadius: 27,
                  hintText: 'Nhập mật khẩu',
                  textAlign: TextAlign.center,
                  textStyle: UITextStyle.semiBold.copyWith(
                    fontSize: 16,
                  ),
                  hintTextStyle: UITextStyle.semiBold.copyWith(
                    fontSize: 16,
                    color: UIColors.gray,
                  ),
                  prefixIcon: const Center(
                    child: AppImage.asset(
                      asset: 'ic_password',
                      width: 24,
                      height: 24,
                      color: UIColors.gray,
                    ),
                  ),
                  contentPadding: const EdgeInsets.only(left: 48, top: 14, bottom: 14),
                  inputFormatter: [
                    FilteringTextInputFormatter.digitsOnly,
                    LengthLimitingTextInputFormatter(6),
                  ],
                  keyboardType: TextInputType.number,
                  onChanged: (value) {
                    if (errMsg != null) {
                      errMsg = null;
                    }
                    setState(() {});
                  },
                )
              ],
            ),
          ),
          const SizedBox(height: 60),
          PrimaryButton(
            width: double.infinity,
            enabled: passwordController.text.length == 6 && confirmPasswordController.text.length == 6,
            onPressed: () {
              if (passwordController.text != confirmPasswordController.text) {
                setState(() {
                  errMsg = 'Mật khẩu xác nhận không đúng.';
                });
                return;
              }
              Navigator.pop(context);
              widget.onComplete?.call(passwordController.text);
            },
            title: 'Đặt mật khẩu',
          )
        ],
      ),
    );
  }
}
