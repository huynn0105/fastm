import 'dart:io';

import 'package:auto_route/auto_route.dart';
import 'package:ekyc/common/utils/text_util.dart';
import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:flutter_module/common/bloc_status.dart';
import 'package:flutter_module/common/colors.dart';
import 'package:flutter_module/common/dialogs/dialog_provider.dart';
import 'package:flutter_module/common/styles.dart';
import 'package:flutter_module/common/widgets/appbar.dart';
import 'package:flutter_module/features/personal_setting/cubit/create_pass_code/create_pass_code_cubit.dart';
import 'package:flutter_module/routes/routes.gr.dart';
import 'package:flutter_module/services/local/local_data_helper.dart';

import '../../../../common/bottom_sheet/bottom_sheet_provider.dart';
import '../../../../common/widgets/buttons.dart';
import '../../../../common/widgets/images.dart';
import '../../../../common/widgets/loading.dart';
import '../../../../common/widgets/simple_pin_code.dart';
import '../../../account/cubit/user/user_cubit.dart';
import '../../../authentication/login/cubit/login_cubit.dart';
import '../../../authentication/login/page/components/veirfy_password_component.dart';
import '../../cubit/security/security_cubit.dart';
import 'components/create_passcode_component.dart';

@RoutePage()
class SecurityPage extends StatelessWidget implements AutoRouteWrapper {
  const SecurityPage({super.key});

  @override
  Widget wrappedRoute(BuildContext context) {
    return MultiBlocProvider(
      providers: [
        BlocProvider(
          create: (_) => LoginCubit(),
          child: this,
        ),
        BlocProvider(
          create: (_) => CreatePassCodeCubit(),
          child: this,
        ),
      ],
      child: this,
    );
  }

  @override
  Widget build(BuildContext context) {
    bool enableLoginPassword = false;
    return BlocBuilder<SecurityCubit, SecurityState>(
      builder: (context, state) {
        return Scaffold(
          backgroundColor: UIColors.background,
          appBar: MFastSimpleAppBar(
            context: context,
            title: 'Mật khẩu và bảo mật',
          ),
          body: Stack(
            children: [
              Column(
                children: [
                  const SizedBox(height: 16),
                  SplashButton(
                    onTap: () {
                      context.router.push(const LoginHistoryRoute());
                    },
                    child: Container(
                      color: UIColors.white,
                      padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 14),
                      child: Row(
                        children: [
                          Expanded(
                            child: Row(
                              crossAxisAlignment: CrossAxisAlignment.start,
                              children: [
                                Container(
                                  alignment: Alignment.topCenter,
                                  child: const Padding(
                                    padding: EdgeInsets.only(top: 2),
                                    child: AppImage.asset(
                                      asset: 'ic_clock_outline',
                                      width: 22,
                                      height: 22,
                                      color: UIColors.accentGreen,
                                    ),
                                  ),
                                ),
                                const SizedBox(width: 12),
                                Expanded(
                                  child: Column(
                                    crossAxisAlignment: CrossAxisAlignment.start,
                                    children: [
                                      Text(
                                        'Lịch sử đăng nhập',
                                        style: UITextStyle.medium.copyWith(
                                          fontSize: 16,
                                        ),
                                      ),
                                      const SizedBox(height: 4),
                                      Text(
                                        'Danh sách lịch sử các phiên đăng nhập',
                                        style: UITextStyle.regular.copyWith(
                                          color: UIColors.extraGrayText,
                                        ),
                                      ),
                                    ],
                                  ),
                                ),
                              ],
                            ),
                          ),
                          const SizedBox(width: 8),
                          const AppImage.asset(
                            asset: 'ic_arrow_right',
                            width: 24,
                            height: 24,
                            color: UIColors.primaryColor,
                          ),
                        ],
                      ),
                    ),
                  ),
                  const SizedBox(height: 16),
                  Container(
                    color: UIColors.white,
                    padding: const EdgeInsets.symmetric(vertical: 14),
                    child: Row(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        const SizedBox(width: 16),
                        Container(
                          alignment: Alignment.topCenter,
                          child: const Padding(
                            padding: EdgeInsets.only(top: 2),
                            child: AppImage.asset(
                              asset: 'ic_unlock_outline',
                              width: 22,
                              height: 22,
                            ),
                          ),
                        ),
                        const SizedBox(width: 12),
                        Expanded(
                          child: Column(
                            children: [
                              Row(
                                children: [
                                  Expanded(
                                    child: Column(
                                      crossAxisAlignment: CrossAxisAlignment.start,
                                      children: [
                                        Text(
                                          'Đăng nhập bằng mật khẩu',
                                          style: UITextStyle.medium.copyWith(
                                            fontSize: 16,
                                          ),
                                        ),
                                        const SizedBox(height: 4),
                                        Text(
                                          'Cho phép sử dụng mật khẩu để đăng nhập',
                                          style: UITextStyle.regular.copyWith(
                                            color: UIColors.extraGrayText,
                                          ),
                                        ),
                                      ],
                                    ),
                                  ),
                                  const SizedBox(width: 8),
                                  BlocBuilder<UserCubit, UserState>(
                                    builder: (context, userState) {
                                      return CupertinoSwitch(
                                        value: state.loginByPassword,
                                        trackColor: UIColors.lightGray,
                                        onChanged: (value) {
                                          if (TextUtils.isNotEmpty(userState.userInfo?.passcode)) {
                                            context.read<SecurityCubit>().toggleLoginByPassword();
                                          } else {
                                            enableLoginPassword = true;
                                            _createPassword(context: context, enableLoginPassword: enableLoginPassword);
                                          }
                                        },
                                      );
                                    },
                                  ),
                                  const SizedBox(width: 16),
                                ],
                              ),
                              const Divider(height: 33, thickness: 1, color: UIColors.lightGray),
                              SplashButton(
                                onTap: () {
                                  enableLoginPassword = false;
                                  _createPassword(context: context, enableLoginPassword: enableLoginPassword);
                                },
                                child: Row(
                                  children: [
                                    Expanded(
                                      child: Text(
                                        'Đổi mật khẩu',
                                        style: UITextStyle.medium.copyWith(
                                          fontSize: 16,
                                        ),
                                      ),
                                    ),
                                    const SizedBox(width: 8),
                                    const AppImage.asset(
                                      asset: 'ic_arrow_right',
                                      width: 24,
                                      height: 24,
                                      color: UIColors.primaryColor,
                                    ),
                                    const SizedBox(width: 16),
                                  ],
                                ),
                              ),
                            ],
                          ),
                        )
                      ],
                    ),
                  ),
                  const SizedBox(height: 16),
                  BlocBuilder<UserCubit, UserState>(
                    builder: (context, userState) {
                      return Container(
                        color: UIColors.white,
                        padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 14),
                        child: Row(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Padding(
                              padding: const EdgeInsets.only(top: 2),
                              child: AppImage.asset(
                                asset: Platform.isIOS ? 'ic_face_id' : 'ic_touch_id',
                                width: 22,
                                height: 22,
                              ),
                            ),
                            const SizedBox(width: 12),
                            Expanded(
                              child: Column(
                                crossAxisAlignment: CrossAxisAlignment.start,
                                children: [
                                  Text(
                                    'Đăng nhập bằng sinh trắc học',
                                    style: UITextStyle.medium.copyWith(
                                      color: TextUtils.isNotEmpty(userState.userInfo?.passcode)
                                          ? UIColors.defaultText
                                          : UIColors.gray,
                                      fontSize: 16,
                                    ),
                                  ),
                                  const SizedBox(height: 4),
                                  Text(
                                    TextUtils.isNotEmpty(userState.userInfo?.passcode)
                                        ? 'Cho phép sử dụng FaceID hoặc vân tân để đăng nhập'
                                        : 'Vui lòng tạo và kích hoạt mật mã MFast trước khi sử dụng tính năng này',
                                    style: UITextStyle.regular.copyWith(
                                      color: UIColors.extraGrayText,
                                    ),
                                  ),
                                ],
                              ),
                            ),
                            const SizedBox(width: 8),
                            CupertinoSwitch(
                              value: state.useBiometric,
                              trackColor: state.loginByPassword ? UIColors.lightGray : UIColors.extraLightGray,
                              onChanged: (value) {
                                if (TextUtils.isNotEmpty(userState.userInfo?.passcode)) {
                                  if (state.useBiometric) {
                                    context.read<SecurityCubit>().toggleBiometric();
                                  } else {
                                    _confirmPassword(context: context);
                                  }
                                }
                              },
                            ),
                          ],
                        ),
                      );
                    },
                  ),
                ],
              ),
              BlocConsumer<LoginCubit, LoginState>(
                listener: (context, state) {
                  if (state.verifyPasswordStatus.isSuccess) {
                    _toggleBiometrics(context);
                  } else if (state.verifyPasswordStatus.isFailure) {
                    _confirmPassword(context: context, errMsg: state.errMsg);
                  }
                },
                builder: (context, state) {
                  return Visibility(
                    visible: state.verifyPasswordStatus.isLoading,
                    child: const LoadingWidget.dark(),
                  );
                },
              ),
              BlocConsumer<CreatePassCodeCubit, CreatePassCodeState>(
                listener: (context, state) {
                  if (state.status.isSuccess) {
                    if (enableLoginPassword) {
                      context.read<SecurityCubit>().toggleLoginByPassword();
                    } else {
                      DialogProvider.instance.showConfirmDialog(context, message: 'Đổi mật khẩu thành công');
                    }
                  } else if (state.status.isFailure) {
                    _createPassword(context: context, errMsg: state.errMsg, enableLoginPassword: enableLoginPassword);
                  }
                },
                builder: (context, state) {
                  return Visibility(
                    visible: state.status.isLoading,
                    child: const LoadingWidget.dark(),
                  );
                },
              ),
            ],
          ),
        );
      },
    );
  }

  _createPassword({required BuildContext context, required bool enableLoginPassword, String? errMsg}) {
    BottomSheetProvider.instance.show(
      context,
      title: 'Đặt mật khẩu',
      child: CreatePassCodeComponent(
        description: 'Đặt mật khẩu gồm 6 chữ số để đăng nhập vào MFast thay cho mã xác thực OTP',
        errMsg: errMsg,
        onComplete: (passCode) {
          showModalBottomSheet(
            backgroundColor: Colors.transparent,
            barrierColor: UIColors.defaultText.withOpacity(0.85),
            context: context,
            isScrollControlled: true,
            builder: (builder) {
              return SimplePinCode(
                mobilePhone: LocalDataHelper.instance.getLoginPhone(),
              );
            },
          ).then((value) {
            if (value is Map) {
              if (value["status"] == true) {
                context.read<CreatePassCodeCubit>().createPassCode(passCode);
              } else {
                DialogProvider.instance.showMTradeErrorDialog(
                  context: context,
                  message: value["message"],
                );
              }
            }
          });
        },
      ),
    );
  }

  _confirmPassword({required BuildContext context, String? errMsg}) {
    if (TextUtils.isEmpty(LocalDataHelper.instance.getPassword())) {
      BottomSheetProvider.instance.show(
        context,
        title: 'Kích hoạt trắc sinh học',
        child: VerifyPasswordComponent(
          description: 'Vui lòng nhập mật khẩu để kích hoạt tính năng đăng nhập bằng sinh trắc học',
          errMsg: errMsg,
          onComplete: (passCode) {
            context.read<LoginCubit>().verifyPassword(passCode);
          },
        ),
      );
    } else {
      _toggleBiometrics(context);
    }
  }

  _toggleBiometrics(BuildContext context) {
    context.read<LoginCubit>().checkAvailableBiometrics(onSuccess: () {
      context.read<SecurityCubit>().toggleBiometric();
    });
  }
}
