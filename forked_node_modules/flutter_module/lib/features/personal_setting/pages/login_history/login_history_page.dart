import 'package:auto_route/auto_route.dart';
import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:flutter_module/common/bloc_status.dart';
import 'package:flutter_module/common/colors.dart';
import 'package:flutter_module/common/enum/academy/background_gradient.dart';
import 'package:flutter_module/common/styles.dart';
import 'package:flutter_module/common/widgets/appbar.dart';
import 'package:flutter_module/common/widgets/loading.dart';
import 'package:flutter_module/common/widgets/loadmore_widget.dart';
import 'package:flutter_module/features/personal_setting/cubit/login_history/login_history_cubit.dart';
import 'package:flutter_module/features/personal_setting/pages/login_history/items/group_login_history_item.dart';
import 'package:flutter_module/features/personal_setting/pages/login_history/items/login_history_item.dart';

@RoutePage()
class LoginHistoryPage extends StatelessWidget implements AutoRouteWrapper {
  const LoginHistoryPage({super.key});

  @override
  Widget wrappedRoute(BuildContext context) {
    return BlocProvider(
      create: (_) => LoginHistoryCubit(),
      child: this,
    );
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: MFastSimpleAppBar(
        context: context,
        title: 'Lịch sử đăng nhập',
      ),
      body: BlocBuilder<LoginHistoryCubit, LoginHistoryState>(
        builder: (context, state) {
          final cubit = context.read<LoginHistoryCubit>();
          if (state.status.isInitial) {
            WidgetsBinding.instance.addPostFrameCallback((timeStamp) {
              cubit.fetchData();
            });
          }
          final data = state.groupHistories.entries.toList();
          return Stack(
            children: [
              Column(
                children: [
                  Padding(
                    padding: const EdgeInsets.all(16),
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Text(
                          'Danh sách lịch sử đăng nhập MFast của bạn. Nếu phát hiện có trường hợp lạ, vui lòng liên hệ hỗ trợ ngay lập tức để tránh lộ thông tin quan trọng',
                          style: UITextStyle.regular.copyWith(
                            fontSize: 13,
                            color: UIColors.grayText,
                          ),
                        ),
                        const SizedBox(
                          height: 8,
                        ),
                        Text(
                          'DANH SÁCH ĐĂNG NHẬP',
                          style: UITextStyle.regular.copyWith(
                            fontSize: 14,
                            color: UIColors.defaultText,
                          ),
                        ),
                      ],
                    ),
                  ),
                  Expanded(
                    child: LoadMoreWidget(
                      onRefresh: () => cubit.refreshData(),
                      onLoadMore: () => cubit.loadMoreData(),
                      child: ListView.separated(
                        padding: EdgeInsets.zero,
                        itemBuilder: (context, index) {
                          return GroupLoginHistoryItem(
                            title: data[index].key,
                            data: data[index].value,
                          );
                        },
                        separatorBuilder: (_, __) => const SizedBox(
                          height: 12,
                        ),
                        itemCount: data.length,
                      ),
                    ),
                  ),
                ],
              ),
              Visibility(
                visible: state.status.isLoading,
                child: const LoadingWidget.dark(),
              ),
            ],
          );
        },
      ),
    );
  }
}
