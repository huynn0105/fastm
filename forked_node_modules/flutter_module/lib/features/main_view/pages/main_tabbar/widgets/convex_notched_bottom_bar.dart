import 'package:auto_route/auto_route.dart';
import 'package:flutter/material.dart';
import 'package:flutter_module/common/event_bus/event_bus.dart';
import 'package:flutter_module/general_config.dart';
import 'package:flutter_module/services/local/local_data_helper.dart';

import '../../../../../common/size.dart';
import '../items/bottom_tab_item.dart';
import '../items/primary_bottom_bar_item.dart';
import 'convex_notched_painter.dart';

class ConvexNotchedBottomBar extends StatelessWidget {
  const ConvexNotchedBottomBar({
    Key? key,
    required this.tabsRouter,
  }) : super(key: key);

  final TabsRouter tabsRouter;

  @override
  Widget build(BuildContext context) {
    return Container(
      height: AppSize.instance.bottomBarHeight,
      width: double.infinity,
      decoration: const BoxDecoration(),
      child: Stack(
        clipBehavior: Clip.none,
        alignment: Alignment.topCenter,
        children: [
          Positioned.fill(
            child: CustomPaint(
              painter: ConvexNotchedPainter(
                top: -25,
                width: 85,
                height: 85,
                cornerRadius: 16,
                shadowColor: Colors.black38,
              ),
            ),
          ),
          Row(
            children: [
              BottomTabItem(
                image: "ic_home",
                text: "Trang chủ",
                isEnable: tabsRouter.activeIndex == 0,
                onTap: () => _onTabChange(0),
              ),
              BottomTabItem(
                image: "ic_client",
                text: "Khách hàng",
                isEnable: tabsRouter.activeIndex == 1,
                onTap: () => _onTabChange(1),
              ),
              const Expanded(
                child: SizedBox(),
              ),
              BottomTabItem(
                image: "ic_income_tab",
                text: "Thu nhập",
                isEnable: tabsRouter.activeIndex == 2,
                onTap: () => _onTabChange(2),
              ),
              BottomTabItem(
                image: "ic_person",
                text: "Cá nhân",
                isEnable: tabsRouter.activeIndex == 3,
                onTap: () => _onTabChange(3),
              ),
            ],
          ),
          PositionedDirectional(
            top: -15,
            end: (AppSize.instance.width - 70) / 2,
            child: const PrimaryBottomBarItem(),
          ),
        ],
      ),
    );
  }

  void _onTabChange(int index) {
    tabsRouter.setActiveIndex(index);
    if (!LocalDataHelper.instance.getIsUserGuideHome()) return;
    if (index == 0) {
      eventBus.fire(StartUserGuideEventBus());
    } else {
      eventBus.fire(DisableUserGuideEventBus());
    }
  }
}
