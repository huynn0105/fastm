import 'package:auto_route/auto_route.dart';
import 'package:flutter/material.dart';
import 'package:flutter_module/common/widgets/buttons.dart';
import 'package:flutter_module/features/shipper/page/shipper/children/delivery_bill_lading/widgets/shipper_delivery_location.dart';
import 'package:flutter_module/models/shipper/bill_lading/shipper_bill_lading_model.dart';
import 'package:timelines/timelines.dart';

import '../../../../../../../common/colors.dart';
import '../../../../../../../common/enum/shipper/delivery_status.dart';
import '../../../../../../../common/styles.dart';
import '../../../../../../../common/utils/format_util.dart';
import '../../../../../../../common/utils/map_utils.dart';
import '../../../../../../../common/widgets/divider.dart';
import '../../../../../../../routes/routes.gr.dart';
import '../../../widgets/shipper_address_widget.dart';
import '../../../widgets/shipper_bill_lading_code_widget.dart';
import '../../../widgets/shipper_customer_widget.dart';
import '../../../widgets/shipper_phone_widget.dart';
import '../widgets/shipper_delivery_node.dart';
import '../widgets/shipper_delivery_status_painter.dart';

class ShipperDeliveryBillLadingItem extends StatelessWidget {
  const ShipperDeliveryBillLadingItem({
    Key? key,
    required this.data,
    required this.isFirst,
    this.showVerticalDashLine = true,
  }) : super(key: key);

  final bool isFirst;
  final bool showVerticalDashLine;
  final ShipperBillLadingModel data;

  @override
  Widget build(BuildContext context) {
    return TimelineTile(
      nodeAlign: TimelineNodeAlign.start,
      node: ShipperDeliveryNode(
        isFirst: isFirst,
        deliveryCode: data.masterDeliveryStatus?.code,
        showVerticalDashLine: showVerticalDashLine,
      ),
      contents: Column(
        mainAxisSize: MainAxisSize.min,
        children: [
          SizedBox(height: isFirst ? 13 : 0,),
          Row(
            children: [
              AppSplashButton(
                onTap: () {
                  MapUtils.openMap(context, data.customer?.latitude, data.customer?.longitude);
                },
                child: Container(
                  height: 28,
                  transform: Matrix4.translationValues(-10, isFirst ? 0 : -2, 0),
                  child: ShipperDeliveryLocation(
                    isFirst: isFirst,
                    deliveryCode: data.masterDeliveryStatus?.code,
                    distance: data.customer?.distance,
                    time: data.customer?.estimatedTime,
                    lat: data.customer?.latitude,
                    lng: data.customer?.longitude,
                  ),
                ),
              ),
              const Spacer(),
              CustomPaint(
                painter: ShipperDeliveryStatusPainter(
                  backgroundColor: _getStatusBackground(),
                ),
                child: Container(
                  height: 28,
                  padding: const EdgeInsets.only(left: 16, right: 12),
                  child: Center(
                    child: Text(
                      _getStatusName(),
                      style: UITextStyle.semiBold.copyWith(
                        color: UIColors.white,
                        height: 1,
                      ),
                    ),
                  ),
                ),
              ),
            ],
          ),
          Padding(
            padding: const EdgeInsets.only(top: 8, bottom: 20, left: 12),
            child: AppSplashButton(
              onTap: () {
                context.pushRoute(ShipperBillLadingDetailRoute(orderCode: data.orderCode ?? ""));
              },
              borderRadius: BorderRadius.circular(12),
              child: Container(
                alignment: Alignment.center,
                padding: const EdgeInsets.symmetric(vertical: 10, horizontal: 16),
                decoration: BoxDecoration(
                  color: UIColors.white,
                  borderRadius: BorderRadius.circular(12),
                ),
                child: Column(
                  mainAxisAlignment: MainAxisAlignment.start,
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Row(
                      children: [
                        Text(
                          "Mã vận đơn:",
                          style: UITextStyle.regular.copyWith(
                            fontSize: 13,
                            color: UIColors.grayText,
                          ),
                        ),
                        const SizedBox(
                          width: 4,
                        ),
                        ShipperBillLadingCodeWidget(
                          orderCode: data.id ?? "",
                          deliveryCode: data.orderDeliveryCode ?? "",
                        ),
                      ],
                    ),
                    const SizedBox(
                      height: 5,
                    ),
                    ShipperAddressWidget(
                      address: data.customer?.addressDelivery ?? "",
                      longitude: data.customer?.longitude,
                      latitude: data.customer?.latitude,
                    ),
                    const DottedDivider(
                      height: 10,
                    ),
                    IntrinsicHeight(
                      child: Row(
                        crossAxisAlignment: CrossAxisAlignment.stretch,
                        children: [
                          Expanded(
                            flex: 3,
                            child: ShipperCustomerWidget(
                              fullname: data.customer?.name ?? "",
                            ),
                          ),
                          const VerticalDivider(
                            width: 16,
                            thickness: 1,
                            color: UIColors.lightGray,
                          ),
                          Expanded(
                            flex: 2,
                            child: Container(
                              alignment: Alignment.centerRight,
                              child: ShipperPhoneWidget(
                                value: FormatUtil.phoneFormat(
                                  data.customer?.phone ?? "",
                                ),
                              ),
                            ),
                          ),
                        ],
                      ),
                    ),
                  ],
                ),
              ),
            ),
          ),
        ],
      ),
    );
  }

  _getStatusBackground() {
    String? deliveryCode = data.masterDeliveryStatus?.code;
    if (deliveryCode == DeliveryStatus.DELAY.name) {
      return UIColors.secondaryColor;
    } else if (deliveryCode == DeliveryStatus.DELIVERY_FAILURE.name) {
      return UIColors.red;
    } else {
      return Colors.transparent;
    }
  }

  _getStatusName() {
    String? deliveryCode = data.masterDeliveryStatus?.code;
    if (deliveryCode == DeliveryStatus.DELAY.name) {
      return 'Chờ giao lại';
    } else if (deliveryCode == DeliveryStatus.DELIVERY_FAILURE.name) {
      return 'Giao thất bại';
    } else {
      return '';
    }
  }
}
