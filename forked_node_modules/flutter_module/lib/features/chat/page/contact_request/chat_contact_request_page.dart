import 'package:auto_route/auto_route.dart';
import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:flutter_module/common/colors.dart';
import 'package:flutter_module/common/widgets/appbar.dart';
import 'package:flutter_module/common/widgets/tabbar/tabbar.dart';
import 'package:flutter_module/features/chat/cubit/chat_requested_contact/chat_requested_contact_cubit.dart';
import 'package:flutter_module/models/chat/contact/chat_request_contact_model.dart';
import 'package:flutter_module/routes/routes.gr.dart';

@RoutePage()
class ChatContactRequestPage extends StatefulWidget implements AutoRouteWrapper {
  const ChatContactRequestPage({
    super.key,
    this.invitations = const [],
    this.sentRequests = const [],
    this.initialIndex = 0,
  });

  final List<ChatRequestContactModel>? invitations;
  final List<ChatRequestContactModel>? sentRequests;
  final int? initialIndex;

  @override
  State<ChatContactRequestPage> createState() => _ChatContactRequestPageState();

  @override
  Widget wrappedRoute(BuildContext context) {
    return BlocProvider(
      create: (context) {
        final cubit = ChatRequestedContactCubit();
        cubit.initData(
          invitations: invitations,
          sentRequests: sentRequests,
        );
        cubit.fetchInvitationAndSendingRequest();
        return cubit;
      },
      child: this,
    );
  }
}

class _ChatContactRequestPageState extends State<ChatContactRequestPage> with SingleTickerProviderStateMixin {
  late final TabController _tabController;
  bool isSetInitialIndex = false;

  @override
  void initState() {
    super.initState();
    _tabController = TabController(length: 2, vsync: this, initialIndex: widget.initialIndex!);
  }

  @override
  void dispose() {
    _tabController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: MFastSimpleAppBar(
        title: 'Danh sách yêu cầu kết bạn',
        context: context,
      ),
      body: AutoTabsRouter(
        routes: const [
          ChatContactRequestReceivedRoute(),
          ChatContactRequestSentRoute(),
        ],
        builder: (BuildContext context, Widget child) {
          if (!isSetInitialIndex) {
            WidgetsBinding.instance.addPostFrameCallback(
              (timeStamp) {
                AutoTabsRouter.of(context).setActiveIndex(widget.initialIndex!);
              },
            );
            isSetInitialIndex = true;
          }
          return Column(
            children: [
              BlocBuilder<ChatRequestedContactCubit, ChatRequestedContactState>(
                builder: (context, state) {
                  return UnderlineIndicatorTabbar(
                    controller: _tabController,
                    backgroundColor: UIColors.background,
                    titles: [
                      "Lời mời kết bạn (${state.invitations.length})",
                      "Đang gửi (${state.sentRequests.length})",
                    ],
                    onTap: (index) {
                      AutoTabsRouter.of(context).setActiveIndex(index);
                    },
                  );
                },
              ),
              Expanded(
                child: child,
              ),
            ],
          );
        },
      ),
    );
  }
}
