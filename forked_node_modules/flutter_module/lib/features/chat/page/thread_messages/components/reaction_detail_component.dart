import 'package:collection/collection.dart';
import 'package:flutter/material.dart';
import 'package:flutter_module/common/colors.dart';
import 'package:flutter_module/common/styles.dart';
import 'package:flutter_module/common/widgets/avatar/chat_avatar.dart';
import 'package:flutter_module/features/chat/page/thread_messages/widgets/reaction_widget.dart';
import 'package:flutter_module/models/chat/message/reaction_model.dart';
import 'package:flutter_module/models/chat/thread/chat_thread_model.dart';
import 'package:flutter_module/services/firebase/firebase_database/firebase_database_util.dart';

class ReactionDetailComponent extends StatelessWidget {
  const ReactionDetailComponent({
    super.key,
    required this.reactions,
    required this.users,
  });

  final Map<String, String> reactions;
  final List<ThreadUserDetail> users;

  @override
  Widget build(BuildContext context) {
    return Container(
      constraints: const BoxConstraints(
        minHeight: 45,
        maxHeight: 315,
      ),
      decoration: BoxDecoration(
        color: UIColors.white,
        borderRadius: BorderRadius.circular(8),
      ),
      child: ListView.separated(
        shrinkWrap: true,
        padding: const EdgeInsets.all(12),
        physics: const ClampingScrollPhysics(),
        itemBuilder: (context, index) {
          final userID = reactions.keys.toList()[index];
          final reaction = reactions.values.toList()[index];
          final user = users.firstWhereOrNull((e) => FirebaseDatabaseUtil.getFirebaseUserID(userID: e.uid) == userID);
          return SizedBox(
            height: 45,
            child: Row(
              children: [
                SizedBox(
                  width: 45,
                  height: 45,
                  child: Stack(
                    clipBehavior: Clip.none,
                    children: [
                      ChatAvatar(
                        url: user?.avatarImage ?? '',
                        name: user?.fullName ?? '',
                        size: 45,
                        isSingleThread: true,
                      ),
                      Positioned(
                        right: -5,
                        bottom: -5,
                        child: ReactionWidget(
                          data: ReactionModel(
                            code: reaction,
                          ),
                        ),
                      ),
                    ],
                  ),
                ),
                const SizedBox(
                  width: 10,
                ),
                Expanded(
                  child: Text(
                    user?.fullName ?? '',
                    style: UITextStyle.regular.copyWith(
                      fontSize: 13,
                      color: UIColors.defaultText,
                    ),
                    maxLines: 2,
                    overflow: TextOverflow.ellipsis,
                  ),
                ),
              ],
            ),
          );
        },
        separatorBuilder: (_, __) => const SizedBox(height: 5),
        itemCount: reactions.length,
      ),
    );
  }
}
