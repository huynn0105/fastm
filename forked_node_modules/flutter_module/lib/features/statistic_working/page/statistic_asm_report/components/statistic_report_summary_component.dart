import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:flutter_module/common/colors.dart';
import 'package:flutter_module/common/enum/statistic_working/statistic_working_level.dart';
import 'package:flutter_module/common/styles.dart';
import 'package:flutter_module/common/widgets/buttons.dart';
import 'package:flutter_module/common/widgets/images.dart';
import 'package:info_popup/info_popup.dart';

import '../../../cubit/statistic_summary_report/statistic_summary_report_cubit.dart';
import 'report_info_popup.dart';
import 'statistic_report_summary_value_component.dart';

class StatisticReportSummaryComponent extends StatefulWidget {
  const StatisticReportSummaryComponent({
    super.key,
    this.inDay = false,
    this.onControllerCreated,
    this.showInfoPopup,
    this.level,
  });

  final bool inDay;
  final OnControllerCreated? onControllerCreated;
  final VoidCallback? showInfoPopup;
  final String? level;

  @override
  State<StatisticReportSummaryComponent> createState() => _StatisticReportSummaryComponentState();
}

class _StatisticReportSummaryComponentState extends State<StatisticReportSummaryComponent> {
  bool _showInfoPopup = false;

  @override
  Widget build(BuildContext context) {
    return BlocBuilder<StatisticSummaryReportCubit, StatisticSummaryReportState>(
      builder: (context, state) {
        final data = (widget.inDay ? state.data?.reportDetails : state.data?.reportDetailsByMonth) ?? [];
        if (data.isEmpty) {
          return ReportBlockWidget(
            inDay: widget.inDay,
            child: Column(
              children: [
                Text(
                  'Kết quả tự khai trong ${widget.inDay ? 'ngày' : 'tháng'}',
                  style: UITextStyle.semiBold.copyWith(
                    color: UIColors.accentBlue,
                  ),
                ),
              ],
            ),
          );
        }
        Widget reportWidget = ReportBlockWidget(
          inDay: widget.inDay,
          child: Column(
            children: [
              Stack(
                children: [
                  Align(
                    alignment: Alignment.center,
                    child: Text(
                      'Kết quả tự khai trong ${widget.inDay ? 'ngày' : 'tháng'}',
                      style: UITextStyle.semiBold.copyWith(
                        color: widget.inDay ? UIColors.accentOrange : UIColors.accentBlue,
                      ),
                    ),
                  ),
                  Visibility(
                    visible: widget.showInfoPopup != null,
                    child: Align(
                      alignment: Alignment.centerRight,
                      child: SplashButton(
                        isDisabled: _showInfoPopup,
                        onTap: () {
                          setState(() {
                            _showInfoPopup = true;
                          });
                          widget.showInfoPopup?.call();
                        },
                        child: AppImage.asset(
                          asset: _showInfoPopup ? 'ic_info_fill' : 'ic_info_outline',
                          width: 24,
                          height: 24,
                          color: _showInfoPopup ? UIColors.primaryColor : null,
                        ),
                      ),
                    ),
                  )
                ],
              ),
              const SizedBox(height: 10),
              StatisticReportSummaryValueComponent(
                details: data,
              ),
            ],
          ),
        );
        if (widget.onControllerCreated != null) {
          return ReportInfoPopup(
            onControllerCreated: widget.onControllerCreated,
            isAgent: StatisticWorkingLevel.getLevel(widget.level).isAgent,
            child: reportWidget,
            onDismissed: () {
              setState(() {
                _showInfoPopup = false;
              });
            },
          );
        }
        return reportWidget;
      },
    );
  }
}

class ReportBlockWidget extends StatelessWidget {
  const ReportBlockWidget({
    super.key,
    required this.inDay,
    this.child,
  });

  final bool inDay;
  final Widget? child;

  @override
  Widget build(BuildContext context) {
    return Container(
      width: double.infinity,
      decoration: BoxDecoration(
        color: inDay ? UIColors.lightOrange : UIColors.lightBlue,
        borderRadius: BorderRadius.circular(8),
      ),
      padding: const EdgeInsets.symmetric(horizontal: 13, vertical: 10),
      child: child,
    );
  }
}
