import 'package:bloc/bloc.dart';
import 'package:equatable/equatable.dart';
import 'package:flutter_module/models/base_model.dart';

import '../../../../common/bloc_status.dart';
import '../../../../common/utils/debounce_util.dart';
import '../../../../models/statistic_working/statistic_report_model.dart';
import '../../../../services/api/statistic_working/payload/get_statistic_report_by_filter_payload.dart';
import '../../repository/statistic_working_repository.dart';

part 'statistic_asm_report_state.dart';

class StatisticAsmTotalReportCubit extends Cubit<StatisticAsmReportState> with StatisticAsmReportCubit {
  StatisticAsmTotalReportCubit() : super(const StatisticAsmReportState());
}

class StatisticAsmNotReportCubit extends Cubit<StatisticAsmReportState> with StatisticAsmReportCubit {
  StatisticAsmNotReportCubit() : super(const StatisticAsmReportState());
}

mixin StatisticAsmReportCubit on Cubit<StatisticAsmReportState> {
  final StatisticWorkingRepository _repository = StatisticWorkingRepository();
  final DebounceUtil _debounce = DebounceUtil(milliseconds: 250);
  int page = 1;
  GetStatisticReportByFilterPayload _payload = GetStatisticReportByFilterPayload();

  fetchData({bool showLoading = true, bool loadMore = false}) async {
    if (showLoading) {
      emit(state.copyWith(status: BlocStatus.loading));
    }
    updatePayload(page: loadMore ? _payload.page! + 1 : 1);
    BaseModel<List<StatisticReportModel>> result = await _repository.getStatisticReportByFilter(_payload);
    final data = loadMore ? [...state.data, ...?result.data] : result.data;

    emit(state.copyWith(
      status: BlocStatus.success,
      data: result.status ? data : [],
    ));
  }

  onDateChanged(String date) {
    _debounce.run(() {
      updatePayload(date: date);
      fetchData();
    });
  }

  onSearch(String keyword) {
    _debounce.run(() {
      updatePayload(filterText: keyword);
      fetchData();
    });
  }

  Future refreshData() async {
    await fetchData(showLoading: false);
  }

  Future loadmoreData() async {
    final length = state.data.length;
    await fetchData(showLoading: false, loadMore: true);
    return length != state.data.length;
  }

  updatePayload({
    String? userID,
    String? filterText,
    String? type,
    String? level,
    String? date,
    int? page,
    String? sortList,
  }) {
    _payload = _payload.copyWith(
      userID: userID,
      filterText: filterText,
      type: type,
      level: level,
      date: date,
      page: page,
      sortList: sortList,
    );
  }

  @override
  Future<void> close() {
    _debounce.cancel();
    return super.close();
  }
}
