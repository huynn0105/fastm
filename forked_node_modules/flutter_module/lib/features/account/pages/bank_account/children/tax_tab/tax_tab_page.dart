import 'package:auto_route/auto_route.dart';
import 'package:collection/collection.dart';
import 'package:flutter/gestures.dart';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:flutter_module/app_data.dart';
import 'package:flutter_module/common/bloc_status.dart';
import 'package:flutter_module/common/colors.dart';
import 'package:flutter_module/common/enum/mfast/liveness_support_status.dart';
import 'package:flutter_module/common/styles.dart';
import 'package:flutter_module/common/utils/deeplink_util.dart';
import 'package:flutter_module/common/utils/text_util.dart';
import 'package:flutter_module/common/widgets/buttons.dart';
import 'package:flutter_module/common/widgets/images.dart';
import 'package:flutter_module/common/widgets/loading.dart';
import 'package:flutter_module/common/widgets/textfields.dart';
import 'package:flutter_module/features/account/cubit/user/user_cubit.dart';
import 'package:flutter_module/features/mfast/page/account_identification/components/status_request_support_component.dart';
import 'package:flutter_module/models/user/user_meta_data_model.dart';
import 'package:flutter_module/routes/routes.gr.dart';
import 'package:flutter_module/services/api/user/payload/update_user_meta_data_payload.dart';

@RoutePage()
class TaxTabPage extends StatefulWidget {
  const TaxTabPage({super.key});

  @override
  State<TaxTabPage> createState() => _TaxTabPageState();
}

class _TaxTabPageState extends State<TaxTabPage> {
  final TextEditingController _controller = TextEditingController();

  @override
  void initState() {
    super.initState();
    WidgetsBinding.instance.addPostFrameCallback((timeStamp) {
      final cubit = context.read<UserCubit>();
      _controller.text = cubit.state.userMetaData?.taxNumber ?? '';
    });
    _controller.addListener(() {
      setState(() {});
    });
  }

  @override
  Widget build(BuildContext context) {
    return BlocBuilder<UserCubit, UserState>(
      buildWhen: (previous, current) =>
          previous.userMetaData != current.userMetaData || previous.status != current.status,
      builder: (context, state) {
        final String taxNumber = state.userMetaData?.taxNumber ?? "";
        final taxRegisterStatus = LivenessSupportStatus.values.firstWhereOrNull(
          (element) => element.name == state.userMetaData?.isReviewTaxNumber,
        );
        final statusMessage = taxRegisterStatus?.isPending == true
            ? "Yêu cầu của bạn đã được ghi nhận, MFast sẽ tiến hành kiểm tra và thông báo ngay khi có kết quả"
            : taxRegisterStatus?.isFailure == true
                ? "Mã số thuế phải được đăng ký bằng số CCCD mới của bạn mới tính là hợp lệ."
                : "";

        return Stack(
          children: [
            ListView(
              padding: EdgeInsets.zero,
              children: [
                Container(
                  padding: const EdgeInsets.all(16),
                  color: UIColors.white,
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      if (taxRegisterStatus != null && !taxRegisterStatus.isSuccess) ...[
                        StatusRequestSupportComponent(
                          margin: EdgeInsets.zero,
                          status: taxRegisterStatus,
                          note: statusMessage,
                        ),
                        const SizedBox(
                          height: 12,
                        ),
                      ],
                      if (taxNumber.isEmpty || !taxRegisterStatus.isSuccess) ...[
                        Text(
                          "Mã số thuế thu nhập cá nhân (MST) của bạn",
                          style: UITextStyle.regular,
                        ),
                      ] else ...[
                        RichText(
                          textAlign: TextAlign.center,
                          text: TextSpan(
                            style: UITextStyle.regular,
                            children: [
                              const TextSpan(text: "Mã số thuế Thu nhập cá nhân tương ứng với CMND/CCCD "),
                              TextSpan(
                                text: state.userMetaData?.countryIdNumber,
                                style: UITextStyle.semiBold.copyWith(
                                  fontSize: 16,
                                  color: UIColors.primaryColor,
                                ),
                              ),
                            ],
                          ),
                        ),
                      ],
                      const SizedBox(
                        height: 8,
                      ),
                      taxRegisterStatus == LivenessSupportStatus.success
                          ? Container(
                              padding: const EdgeInsets.all(12),
                              decoration: const BoxDecoration(
                                borderRadius: BorderRadius.all(Radius.circular(8)),
                                color: Color(0xffeaeef6),
                              ),
                              alignment: Alignment.center,
                              child: Text(
                                _controller.text,
                                style: UITextStyle.semiBold.copyWith(
                                  color: const Color(0xff231fac),
                                  fontSize: 24,
                                ),
                              ),
                            )
                          : UITextFieldOutline(
                              controller: _controller,
                              fillColor: UIColors.background,
                              hintText: "Nhập mã số thuế",
                              readOnly: taxRegisterStatus == LivenessSupportStatus.success ||
                                  taxRegisterStatus == LivenessSupportStatus.pending,
                              hintTextStyle: UITextStyle.regular.copyWith(
                                fontSize: 16,
                                color: UIColors.gray,
                              ),
                              textStyle: UITextStyle.medium.copyWith(
                                fontSize: 16,
                              ),
                              inputFormatter: [
                                FilteringTextInputFormatter.digitsOnly,
                              ],
                              keyboardType: TextInputType.number,
                            ),
                      const SizedBox(
                        height: 16,
                      ),
                      if (taxNumber.isNotEmpty && taxRegisterStatus.isPending) ...[
                        SplashButton(
                          onTap: () {
                            _onRefetch(context);
                          },
                          child: Row(
                            mainAxisAlignment: MainAxisAlignment.center,
                            children: [
                              const AppImage.asset(
                                asset: "ic_refresh",
                                width: 24,
                                height: 24,
                              ),
                              const SizedBox(
                                width: 8,
                              ),
                              Text(
                                "Kiểm tra lại thông tin",
                                style: UITextStyle.regular.copyWith(
                                  color: UIColors.primaryColor,
                                ),
                              )
                            ],
                          ),
                        )
                      ] else ...[
                        Visibility(
                          visible: taxRegisterStatus != LivenessSupportStatus.success,
                          child: Row(
                            children: [
                              Expanded(
                                child: AppOutlinedButton(
                                  onPressed: () {
                                    context.pushRoute(const RegisterTaxRoute());
                                  },
                                  title: "Đăng ký tạo MST",
                                  borderRadius: BorderRadius.circular(24),
                                  textColor: UIColors.grayText,
                                  borderColor: UIColors.grayBackground,
                                  borderWidth: 1,
                                ),
                              ),
                              const SizedBox(
                                width: 16,
                              ),
                              Expanded(
                                child: PrimaryButton(
                                  enabled: state.userMetaData?.taxNumber != _controller.text,
                                  onPressed: () {
                                    _onUpdateTax(context);
                                  },
                                  title: "Cập nhật",
                                ),
                              )
                            ],
                          ),
                        ),
                      ],
                      const SizedBox(
                        height: 8,
                      ),
                    ],
                  ),
                ),
                const SizedBox(
                  height: 16,
                ),

                // Group 1282
                Padding(
                  padding: const EdgeInsets.symmetric(horizontal: 16),
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text(
                        "Lưu ý:",
                        style: UITextStyle.semiBold,
                      ),
                      const SizedBox(
                        height: 8,
                      ),
                      Row(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Text("-", style: UITextStyle.regular, textAlign: TextAlign.left),
                          const SizedBox(
                            width: 8,
                          ),
                          Expanded(
                            child: RichText(
                              text: TextSpan(
                                style: UITextStyle.regular,
                                children: [
                                  const TextSpan(
                                    text: "Trường hợp bạn ",
                                  ),
                                  TextSpan(
                                    style: UITextStyle.bold.copyWith(
                                      color: UIColors.red,
                                    ),
                                    text: "chưa từng có MST",
                                  ),
                                  const TextSpan(
                                    text:
                                        ", vui lòng cung cấp thêm thông tin để được hỗ trợ đăng ký MST TNCN. Hoặc trực tiếp ra Cơ quan thuế gần nhất để được hỗ trợ.",
                                  )
                                ],
                              ),
                            ),
                          )
                        ],
                      ),
                      const SizedBox(
                        height: 10,
                      ),
                      Row(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Text("-", style: UITextStyle.regular, textAlign: TextAlign.left),
                          const SizedBox(
                            width: 8,
                          ),
                          Expanded(
                            child: RichText(
                              text: TextSpan(
                                style: UITextStyle.regular,
                                children: [
                                  const TextSpan(
                                    text: "Trong trường hợp bạn ",
                                  ),
                                  TextSpan(
                                    style: UITextStyle.bold.copyWith(
                                      color: UIColors.red,
                                    ),
                                    text: "Trong trường hợp bạn đã có MST trước đó theo CMND cũ",
                                  ),
                                  const TextSpan(
                                    text:
                                        ", vui lòng trực tiếp ra Cơ quan thuế để cập nhật thông tin theo CCCD mới sau đó bấm “Kiểm tra lại thông tin”.",
                                  ),
                                ],
                              ),
                            ),
                          )
                        ],
                      ),
                      const SizedBox(
                        height: 10,
                      ),
                      Row(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Text("-", style: UITextStyle.regular, textAlign: TextAlign.left),
                          const SizedBox(
                            width: 8,
                          ),
                          Expanded(
                            child: RichText(
                              text: TextSpan(
                                style: UITextStyle.regular,
                                children: [
                                  const TextSpan(
                                    text: "Nếu bạn cần cung cấp ",
                                  ),
                                  TextSpan(
                                    style: UITextStyle.bold.copyWith(
                                      color: UIColors.red,
                                    ),
                                    text: "chứng từ thuế",
                                  ),
                                  const TextSpan(
                                    text: " để xác minh thu nhập trên MFast, vui lòng bấm ",
                                  ),
                                  TextSpan(
                                    text: "tại đây >",
                                    recognizer: TapGestureRecognizer()
                                      ..onTap = () {
                                        final ctt = state.userSettingData
                                            .firstWhereOrNull((x) => x.id == 'TRUNGTAMHOTRO')
                                            ?.headerData
                                            ?.firstWhereOrNull((x) => x.alias == 'tax_vouchers');
                                        if (ctt != null) {
                                          if (ctt.action == null || !TextUtils.isDeeplink(ctt.action)) return;
                                          DeepLinkUtil.open(ctt.action, forceOpenDeeplink: true);
                                        }
                                      },
                                    style: UITextStyle.semiBold.copyWith(
                                      color: UIColors.primaryColor,
                                    ),
                                  )
                                ],
                              ),
                            ),
                          )
                        ],
                      ),
                      const SizedBox(
                        height: 16,
                      ),
                      SplashButton(
                        onTap: () {
                          context.router.push(WebViewRoute(
                            title: 'Quy định khấu trừ thuế TNCN',
                            url: AppData.instance.appInfo.regulationTaxUrl ?? '',
                          ));
                        },
                        child: Container(
                          padding: const EdgeInsets.symmetric(
                            horizontal: 12,
                            vertical: 8,
                          ),
                          decoration: BoxDecoration(
                            color: UIColors.white,
                            borderRadius: BorderRadius.circular(8),
                          ),
                          child: Row(
                            children: [
                              Expanded(
                                child: Text(
                                  "Quy định khấu trừ và tạm giữ thuế Thu nhập cá nhân đối với thu nhập trên MFast",
                                  style: UITextStyle.regular.copyWith(
                                    color: UIColors.primaryColor,
                                  ),
                                ),
                              ),
                              const SizedBox(
                                width: 12,
                              ),
                              const AppImage.asset(
                                asset: 'ic_arrow_right',
                                width: 16,
                                height: 16,
                                color: UIColors.primaryColor,
                              ),
                            ],
                          ),
                        ),
                      )
                    ],
                  ),
                ),
              ],
            ),
            Visibility(
              visible: state.status.isLoading,
              child: const LoadingWidget.dark(),
            )
          ],
        );
      },
    );
  }

  _onRefetch(BuildContext context) {
    final cubit = context.read<UserCubit>();
    cubit.getUserMetaData();
  }

  _onUpdateTax(BuildContext context) {
    final cubit = context.read<UserCubit>();
    cubit.updateUserMetaData(UpdateUserMetaDataPayload(
        user: UserMetaDataModel(
      taxNumber: _controller.text,
      isReviewTaxNumber: LivenessSupportStatus.pending.name,
    )));
  }
}
