import 'package:flutter/material.dart';
import 'package:flutter_module/common/colors.dart';
import 'package:flutter_module/common/styles.dart';
import 'package:flutter_module/common/utils/format_util.dart';
import 'package:flutter_module/common/utils/text_util.dart';
import 'package:flutter_module/common/widgets/buttons.dart';
import 'package:flutter_module/common/widgets/images.dart';
import 'package:flutter_module/common/widgets/separated_widget.dart';
import 'package:flutter_module/features/mfast/page/time_checking_report_detail/widgets/report_info_detail_widget.dart';
import 'package:flutter_module/models/mfast/report/report_model.dart';

import '../../../../../common/enum/mfast/report_item_type.dart';

class ReportInfoWidget extends StatelessWidget {
  const ReportInfoWidget({
    super.key,
    required this.title,
    required this.imageURL,
    required this.items,
    this.showEditButton,
    this.onEdit,
  });

  final String title;
  final String imageURL;
  final List<ReportItemModel> items;
  final bool? showEditButton;
  final Function()? onEdit;

  @override
  Widget build(BuildContext context) {
    return Container(
      decoration: BoxDecoration(
        color: UIColors.white,
        borderRadius: BorderRadius.circular(12),
        border: Border.all(
          color: UIColors.white,
        ),
      ),
      child: Column(
        children: [
          Container(
            height: 48,
            padding: const EdgeInsets.symmetric(horizontal: 16),
            decoration: const BoxDecoration(
              color: UIColors.extraLightBlue,
              borderRadius: BorderRadius.only(
                topLeft: Radius.circular(12),
                topRight: Radius.circular(12),
              ),
            ),
            child: Stack(
              children: [
                Align(
                  alignment: Alignment.centerLeft,
                  child: AppImage.network(
                    url: imageURL,
                    height: 30,
                    width: null,
                    fit: BoxFit.contain,
                  ),
                ),
                Positioned.fill(
                  child: Row(
                    children: [
                      const SizedBox(
                        width: 30,
                        height: 30,
                      ),
                      Expanded(
                        child: Center(
                          child: Text(
                            title,
                            style: UITextStyle.semiBold.copyWith(
                              fontSize: 16,
                              color: UIColors.defaultText,
                            ),
                            textAlign: TextAlign.center,
                            maxLines: 1,
                            overflow: TextOverflow.ellipsis,
                          ),
                        ),
                      ),
                      SizedBox(
                        height: 30,
                        width: 30,
                        child: Visibility(
                          visible: showEditButton == true,
                          child: AppSplashButton(
                            onTap: onEdit,
                            child: Container(
                              height: 30,
                              width: 30,
                              alignment: Alignment.center,
                              child: const AppImage.asset(
                                asset: 'ic_edit',
                                height: 24,
                                width: 24,
                              ),
                            ),
                          ),
                        ),
                      ),
                    ],
                  ),
                ),
              ],
            ),
          ),
          Container(
            padding: const EdgeInsets.all(16),
            decoration: const BoxDecoration(
              borderRadius: BorderRadius.only(
                bottomLeft: Radius.circular(12),
                bottomRight: Radius.circular(12),
              ),
            ),
            child: ListView.separated(
              shrinkWrap: true,
              padding: EdgeInsets.zero,
              physics: const NeverScrollableScrollPhysics(),
              itemBuilder: (context, index) {
                final item = items[index];
                final children = item.items;
                final isSum = item.isSum;
                final childrenLength = isSum ? children.length + 1 : children.length;
                final totalValue = item.items.map((e) => e.value ?? 0).reduce((pre, cur) => pre + cur);

                ///
                return SeparatedRow(
                  separatorBuilder: (_, __) => const SizedBox(
                    width: 4,
                  ),
                  children: List.generate(
                    childrenLength,
                    (index) {
                      if (isSum && index == childrenLength - 1) {
                        return Expanded(
                          flex: 1,
                          child: ReportInfoDetailWidget(
                            label: 'Tá»•ng',
                            value: totalValue.toString(),
                          ),
                        );
                      }
                      final item = children[index];
                      String displayValue = item.value?.toString() ?? '';
                      if (item.type == ReportItemType.money) {
                        displayValue = FormatUtil.currencyDoubleFormat(TextUtils.parseDouble(displayValue));
                      }
                      return Expanded(
                        flex: 2,
                        child: ReportInfoDetailWidget(
                          label: item.label,
                          value: item.displayValue ?? displayValue,
                        ),
                      );
                    },
                  ),
                );
              },
              separatorBuilder: (_, __) => const Divider(
                height: 16,
                color: UIColors.extraLightGray,
              ),
              itemCount: items.length,
            ),
          ),
        ],
      ),
    );
  }
}
