import 'package:cached_network_image/cached_network_image.dart';
import 'package:flutter/cupertino.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:flutter_module/common/colors.dart';
import 'package:flutter_module/common/dialogs/dialog_provider.dart';
import 'package:flutter_module/common/styles.dart';
import 'package:flutter_module/common/widgets/buttons.dart';
import 'package:flutter_module/common/widgets/collect_data_view.dart';
import 'package:flutter_module/common/widgets/images.dart';
import 'package:flutter_module/common/widgets/textfields.dart';
import 'package:flutter_module/features/mfast/cubit/time_checking_report/time_checking_report_cubit.dart';
import 'package:flutter_module/models/mfast/report/report_model.dart';

part './report_item_detail.dart';

class ReportItem extends StatelessWidget {
  const ReportItem({
    super.key,
    this.onRemove,
    required this.reportField,
    required this.type,
    this.enabledRemove = true,
    this.onValueChange,
  });

  final ReportItemField reportField;
  final VoidCallback? onRemove;
  final ReportType type;
  final bool enabledRemove;
  final Function(String? newValue)? onValueChange;

  @override
  Widget build(BuildContext context) {
    return Container(
      decoration: BoxDecoration(
        borderRadius: BorderRadius.circular(12),
        color: UIColors.white,
      ),
      child: Column(
        children: [
          _Header(
            reportName: reportField.report.title,
            imageUrl: reportField.report.image,
            enabledRemove: enabledRemove,
            onRemove: () {
              DialogProvider.instance.showMTradeDialog(
                context: context,
                asset: 'ic_wait',
                message:
                    'Bạn có muốn bỏ khai báo ${type.description} “${reportField.report.title}” ra khỏi báo cáo này?',
                title: 'Xác nhận bỏ khai báo ${type.description}',
                positiveCallback: onRemove,
                positiveTitle: 'Bỏ ${type.description}',
                negativeTitle: 'Quay lại',
                titleColor: UIColors.accentOrange,
                borderRadius: 24,
              );
            },
          ),
          Padding(
            padding: const EdgeInsets.all(16),
            child: Column(
              children: reportField.report.items
                  .map((e) => _ReportItemDetail(
                        reportItem: e,
                        reportField: reportField,
                        type: type,
                        onValueChange: onValueChange,
                      ))
                  .toList(),
            ),
          ),
        ],
      ),
    );
  }
}

class _Header extends StatelessWidget {
  const _Header({
    super.key,
    required this.reportName,
    required this.onRemove,
    required this.imageUrl,
    this.enabledRemove = true,
  });

  final String reportName;
  final String imageUrl;
  final VoidCallback onRemove;
  final bool enabledRemove;

  @override
  Widget build(BuildContext context) {
    return Container(
      decoration: const BoxDecoration(
        color: UIColors.extraLightBlue,
        borderRadius: BorderRadius.only(
          topLeft: Radius.circular(12),
          topRight: Radius.circular(12),
        ),
      ),
      padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 10),
      child: Stack(
        children: [
          Align(
            alignment: Alignment.centerLeft,
            child: CachedNetworkImage(
              imageUrl: imageUrl,
              height: 30,
              fit: BoxFit.cover,
              progressIndicatorBuilder: (context, url, progress) => const SizedBox(
                height: 30,
                width: 30,
                child: CupertinoActivityIndicator(),
              ),
            ),
          ),
          Align(
            alignment: Alignment.center,
            child: Text(
              reportName,
              style: UITextStyle.semiBold.copyWith(
                fontSize: 16,
                color: UIColors.accentBlack,
              ),
            ),
          ),
          Visibility(
            visible: enabledRemove,
            child: Align(
              alignment: Alignment.centerRight,
              child: AppSplashButton(
                onTap: onRemove,
                child: const AppImage.asset(
                  asset: 'ic_trash',
                  width: 30,
                  height: 30,
                ),
              ),
            ),
          ),
        ],
      ),
    );
  }
}
