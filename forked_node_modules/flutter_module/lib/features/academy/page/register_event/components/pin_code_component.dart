import 'package:flutter/foundation.dart';
import 'package:flutter/gestures.dart';
import 'package:flutter/material.dart';
import 'package:flutter_module/common/widgets/loading.dart';
import 'package:pin_code_fields/pin_code_fields.dart';

import '../../../../../../../../common/colors.dart';
import '../../../../../../../../common/constants.dart';
import '../../../../../../../../common/styles.dart';
import '../../../../../../../../common/utils/format_util.dart';
import '../../../../../../../../common/widgets/buttons.dart';
import '../../../../../../../../common/widgets/collect_data_view.dart';
import '../../../../../../../../common/widgets/images.dart';

class PinCodeComponent extends StatefulWidget {
  final String phoneNumber;
  final Function(String)? onCompleted;
  final bool hideHeader;

  const PinCodeComponent({
    Key? key,
    this.phoneNumber = '',
    this.onCompleted,
    this.hideHeader = false,
  }) : super(key: key);

  @override
  State<StatefulWidget> createState() {
    return _PinCodeState();
  }
}

class _PinCodeState extends State<PinCodeComponent> {
  late final TextEditingController inputController;

  @override
  void initState() {
    inputController = TextEditingController();
    super.initState();
  }

  @override
  void dispose() {
    inputController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    bool hasError = false;
    int countDown = 60;

    return Stack(
      alignment: Alignment.bottomCenter,
      children: [
        LayoutBuilder(
          builder: (context, constraints) {
            return SizedBox(
              height: 628,
              width: double.infinity,
              child: Column(
                children: [
                  if (!widget.hideHeader) ...[
                    Container(
                      height: 6,
                      width: 92,
                      decoration: BoxDecoration(
                        borderRadius: BorderRadius.circular(3),
                        color: UIColors.white,
                      ),
                    ),
                    const SizedBox(
                      height: 10,
                    ),
                  ],
                  Container(
                    height: 612,
                    width: constraints.maxWidth >= AppConstants.responsiveSize ? AppConstants.responsiveSize : null,
                    decoration: const BoxDecoration(
                      color: UIColors.extraLightGray,
                      borderRadius: BorderRadius.only(
                        topLeft: Radius.circular(24),
                        topRight: Radius.circular(24),
                      ),
                    ),
                    child: Column(
                      children: [
                        if (!widget.hideHeader) ...[
                          Container(
                            decoration: const BoxDecoration(
                              color: UIColors.white,
                              borderRadius: BorderRadius.only(
                                topLeft: Radius.circular(24),
                                topRight: Radius.circular(24),
                              ),
                              boxShadow: [
                                BoxShadow(
                                  offset: Offset(0, 1),
                                  color: UIColors.extraLightGray,
                                  blurRadius: 1,
                                )
                              ],
                            ),
                            height: 48,
                            child: Stack(
                              children: [
                                Positioned(
                                  top: 12,
                                  left: 0,
                                  right: 0,
                                  bottom: 14,
                                  child: Text(
                                    'Xác thực nhu cầu',
                                    textAlign: TextAlign.center,
                                    style: UITextStyle.medium.copyWith(
                                      fontSize: 16,
                                      color: UIColors.grayText,
                                    ),
                                  ),
                                ),
                                Positioned(
                                  top: 12,
                                  right: 12,
                                  child: SplashButton(
                                    onTap: () => Navigator.pop(context),
                                    child: const AppImage.asset(
                                      asset: 'ic_close',
                                      height: 24,
                                      width: 24,
                                    ),
                                  ),
                                ),
                              ],
                            ),
                          ),
                          const Divider(
                            height: 1,
                            color: UIColors.lightGray,
                          ),
                          const SizedBox(
                            height: 24,
                          ),
                        ],
                        Text.rich(
                          TextSpan(
                            children: <InlineSpan>[
                              const TextSpan(
                                text: 'Nhập mã xác thực ',
                              ),
                              TextSpan(
                                text: '4 chữ số',
                                style: UITextStyle.bold,
                              ),
                              const TextSpan(
                                text: ' đã được gửi tới\nsố ĐT ',
                              ),
                              TextSpan(
                                text: FormatUtil.phoneFormat(widget.phoneNumber),
                                style: UITextStyle.bold,
                              ),
                            ],
                            style: UITextStyle.regular.copyWith(
                              color: UIColors.grayText,
                            ),
                          ),
                          textAlign: TextAlign.center,
                        ),
                        const SizedBox(
                          height: 8,
                        ),
                        CollectDataView(
                          errorAlignment: MainAxisAlignment.center,
                          errorMsg: '',
                          child: Padding(
                            padding: const EdgeInsets.only(bottom: 8),
                            child: PinCodeTextField(
                              appContext: context,
                              length: 4,
                              errorTextSpace: 0,
                              errorTextMargin: EdgeInsets.zero,
                              mainAxisAlignment: MainAxisAlignment.center,
                              animationType: AnimationType.fade,
                              autoDisposeControllers: false,
                              enablePinAutofill: kIsWeb == false,
                              pinTheme: PinTheme(
                                shape: PinCodeFieldShape.box,
                                borderRadius: BorderRadius.circular(4),
                                fieldHeight: 40,
                                fieldWidth: 40,
                                borderWidth: 1,
                                fieldOuterPadding: const EdgeInsets.only(left: 6, right: 6),
                                activeColor: hasError ? UIColors.red : UIColors.border,
                                selectedColor: hasError ? UIColors.red : UIColors.primaryColor,
                                inactiveColor: hasError ? UIColors.red : UIColors.border,
                                disabledColor: UIColors.border,
                                activeFillColor: hasError ? UIColors.lightRed : UIColors.white,
                                selectedFillColor: hasError ? UIColors.lightRed : UIColors.lightBlue,
                                inactiveFillColor: hasError ? UIColors.lightRed : UIColors.white,
                                errorBorderColor: UIColors.white,
                              ),
                              cursorColor: UIColors.defaultText,
                              animationDuration: const Duration(milliseconds: 300),
                              enableActiveFill: true,
                              // errorAnimationController: errorController,
                              controller: inputController,
                              keyboardType: TextInputType.number,
                              onCompleted: (v) {
                                widget.onCompleted!(v);
                              },
                              onChanged: (v) {
                                // otp change
                              },
                            ),
                          ),
                        ),
                        const SizedBox(
                          height: 8,
                        ),
                        Text.rich(
                          TextSpan(
                            children: <InlineSpan>[
                              const TextSpan(
                                text: 'Nếu không nhận được mã xác thực,\nbấm ',
                              ),
                              if (countDown > 1)
                                TextSpan(
                                  text: 'gửi lại sau ${countDown}s',
                                  style: UITextStyle.bold,
                                ),
                              if (countDown == 1)
                                TextSpan(
                                  text: 'Gửi lại ngay',
                                  style: UITextStyle.semiBold.copyWith(
                                    color: UIColors.primaryColor,
                                  ),
                                  recognizer: TapGestureRecognizer()
                                    ..onTap = () {
                                      // retry otp
                                    },
                                ),
                            ],
                            style: UITextStyle.regular.copyWith(
                              color: UIColors.grayText,
                            ),
                          ),
                          textAlign: TextAlign.center,
                        ),
                      ],
                    ),
                  ),
                ],
              ),
            );
          },
        ),
        const Visibility(
          visible: false,
          child: LoadingWidget(),
        ),
      ],
    );
  }
}
