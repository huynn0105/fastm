package com.digipay.mfast

import android.content.Intent
import com.vnpay.authentication.VNP_AuthenticationActivity
import com.vnpay.authentication.VNP_SdkCompletedCallback
import io.flutter.Log
import io.flutter.embedding.android.FlutterFragmentActivity
import io.flutter.embedding.engine.FlutterEngine
import io.flutter.plugin.common.MethodChannel

class MainActivity : FlutterFragmentActivity() {


    private val CHANNEL = "flutter.native/mfast"
    private var vnPayResult: MethodChannel.Result? = null

    override fun configureFlutterEngine(flutterEngine: FlutterEngine) {
        super.configureFlutterEngine(flutterEngine)
        MethodChannel(flutterEngine.dartExecutor.binaryMessenger, CHANNEL).setMethodCallHandler { call, result ->
            if (call.method == "openVNPay") {
                val url: String? = call.argument("url")
                val tmnCode: String? = call.argument("tmnCode")
                val scheme: String? = call.argument("scheme")
                val isSanbox: Boolean? = call.argument("isSanbox")
                openVNPay(url, tmnCode, scheme, isSanbox) // Method to start the SDK
                vnPayResult = result
            }
        }

    }

    private fun openVNPay(url: String?, tmnCode: String?, scheme: String?, isSanbox: Boolean?) {
        val intent = Intent(this, VNP_AuthenticationActivity::class.java)
        intent.putExtra("url", url) //bắt buộc, VNPAY cung cấp
        intent.putExtra("tmn_code", tmnCode) //bắt buộc, VNPAY cung cấp
        intent.putExtra("scheme", scheme)
        //bắt buộc, scheme để mở lại app khi có kết quả thanh toán từ mobile banking
        intent.putExtra("is_sandbox", isSanbox)
        intent.flags = Intent.FLAG_ACTIVITY_NEW_TASK
        actionBar?.hide()

        VNP_AuthenticationActivity.setSdkCompletedCallback(vnPaySDKAction)
        startActivity(intent)
    }

    private val vnPaySDKAction: VNP_SdkCompletedCallback = VNP_SdkCompletedCallback {
        println("Action: $it")
        Log.wtf("SplashActivity", "action: $it")
        //                action == AppBackAction
        //Người dùng nhấn back từ sdk để quay lại

        //                action == CallMobileBankingApp
        //Người dùng nhấn chọn thanh toán qua app thanh toán (Mobile Banking, Ví...)
        //lúc này app tích hợp sẽ cần lưu lại cái PNR, khi nào người dùng mở lại app tích hợp thì sẽ gọi kiểm tra trạng thái thanh toán của PNR Đó xem đã thanh toán hay chưa.

        //action == WebBackAction
        //Người dùng nhấn back từ trang thanh toán thành công khi thanh toán qua thẻ khi url có chứa: cancel.sdk.merchantbackapp

        //action == FaildBackAction
        //giao dịch thanh toán bị failed

        //action == SuccessBackAction
        //thanh toán thành công trên webview
        vnPayResult?.success(it)
        actionBar?.show()
    }
}
